"""
æµ¦å’Œã‚«ãƒƒãƒ— SDKç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - Issueç®¡ç†
"""

import json
from datetime import datetime
from pathlib import Path
from typing import List, Optional
from dataclasses import dataclass, asdict

import sys
sys.path.insert(0, str(Path(__file__).parent.parent))

from config import ISSUE_DIR, LOG_DIR


@dataclass
class Issue:
    """Issueå®šç¾©"""
    id: int
    title: str
    description: str
    category: str  # "architecture", "code", "test", "documentation"
    severity: str  # "critical", "high", "medium", "low"
    status: str  # "open", "in_progress", "resolved", "closed"
    location: Optional[str] = None
    fix_suggestion: Optional[str] = None
    created_at: str = ""
    updated_at: str = ""
    resolved_at: Optional[str] = None

    def __post_init__(self):
        if not self.created_at:
            self.created_at = datetime.now().isoformat()
        if not self.updated_at:
            self.updated_at = self.created_at


class IssueManager:
    """Issueç®¡ç†ã‚¯ãƒ©ã‚¹"""

    def __init__(self):
        self.issues: List[Issue] = []
        self.issue_file = ISSUE_DIR / "AutoGeneratedIssues.json"
        self.markdown_file = ISSUE_DIR / "AutoGeneratedIssues.md"
        self._load_issues()

    def _load_issues(self):
        """æ—¢å­˜Issueã‚’èª­ã¿è¾¼ã¿"""
        if self.issue_file.exists():
            try:
                data = json.loads(self.issue_file.read_text(encoding="utf-8"))
                self.issues = [Issue(**item) for item in data]
            except (json.JSONDecodeError, TypeError):
                self.issues = []

    def _save_issues(self):
        """Issueã‚’ä¿å­˜"""
        ISSUE_DIR.mkdir(exist_ok=True)

        # JSONä¿å­˜
        data = [asdict(issue) for issue in self.issues]
        self.issue_file.write_text(
            json.dumps(data, ensure_ascii=False, indent=2),
            encoding="utf-8"
        )

        # Markdownä¿å­˜
        self._save_markdown()

    def _save_markdown(self):
        """Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§Issueä¸€è¦§ã‚’ä¿å­˜"""
        content = "# è‡ªå‹•ç”ŸæˆIssueä¸€è¦§\n\n"
        content += f"æœ€çµ‚æ›´æ–°: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n"

        # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡
        categories = {}
        for issue in self.issues:
            if issue.category not in categories:
                categories[issue.category] = []
            categories[issue.category].append(issue)

        # Open Issues
        open_issues = [i for i in self.issues if i.status in ("open", "in_progress")]
        content += f"## Open Issues ({len(open_issues)})\n\n"

        for category, issues in categories.items():
            category_open = [i for i in issues if i.status in ("open", "in_progress")]
            if category_open:
                content += f"### {category.upper()}\n\n"
                for issue in category_open:
                    status_badge = "ğŸ”´" if issue.severity == "critical" else "ğŸŸ " if issue.severity == "high" else "ğŸŸ¡"
                    content += f"#### {status_badge} Issue #{issue.id:03d}: {issue.title}\n"
                    content += f"- **æ·±åˆ»åº¦**: {issue.severity}\n"
                    content += f"- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: {issue.status}\n"
                    if issue.location:
                        content += f"- **å ´æ‰€**: `{issue.location}`\n"
                    content += f"- **èª¬æ˜**: {issue.description}\n"
                    if issue.fix_suggestion:
                        content += f"- **ä¿®æ­£æ¡ˆ**: {issue.fix_suggestion}\n"
                    content += "\n"

        # Resolved Issues
        resolved = [i for i in self.issues if i.status in ("resolved", "closed")]
        content += f"\n## Resolved Issues ({len(resolved)})\n\n"
        for issue in resolved:
            content += f"- ~~Issue #{issue.id:03d}: {issue.title}~~ (è§£æ±º: {issue.resolved_at or 'N/A'})\n"

        self.markdown_file.write_text(content, encoding="utf-8")

    def create_issue(
        self,
        title: str,
        description: str,
        category: str,
        severity: str = "medium",
        location: Optional[str] = None,
        fix_suggestion: Optional[str] = None,
    ) -> Issue:
        """æ–°è¦Issueã‚’ä½œæˆ"""
        issue_id = max((i.id for i in self.issues), default=0) + 1

        issue = Issue(
            id=issue_id,
            title=title,
            description=description,
            category=category,
            severity=severity,
            status="open",
            location=location,
            fix_suggestion=fix_suggestion,
        )

        self.issues.append(issue)
        self._save_issues()

        return issue

    def update_status(self, issue_id: int, status: str):
        """Issueã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°"""
        for issue in self.issues:
            if issue.id == issue_id:
                issue.status = status
                issue.updated_at = datetime.now().isoformat()
                if status in ("resolved", "closed"):
                    issue.resolved_at = datetime.now().isoformat()
                break
        self._save_issues()

    def get_open_issues(self, category: Optional[str] = None) -> List[Issue]:
        """Open Issueã‚’å–å¾—"""
        issues = [i for i in self.issues if i.status in ("open", "in_progress")]
        if category:
            issues = [i for i in issues if i.category == category]
        return issues

    def get_critical_issues(self) -> List[Issue]:
        """é‡è¦åº¦ãŒé«˜ã„Issueã‚’å–å¾—"""
        return [
            i for i in self.issues
            if i.status in ("open", "in_progress") and i.severity in ("critical", "high")
        ]

    def create_architecture_violation_issue(
        self,
        rule_name: str,
        description: str,
        location: str,
        fix_suggestion: str,
    ) -> Issue:
        """ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é•åIssueã‚’ä½œæˆ"""
        return self.create_issue(
            title=f"ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£é•å: {rule_name}",
            description=description,
            category="architecture",
            severity="high",
            location=location,
            fix_suggestion=fix_suggestion,
        )


if __name__ == "__main__":
    # ãƒ†ã‚¹ãƒˆ
    manager = IssueManager()

    # ãƒ†ã‚¹ãƒˆç”¨Issueä½œæˆ
    issue = manager.create_issue(
        title="HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé‡è¤‡",
        description="utils/api.tsã¨api/client.tsã®ä¸¡æ–¹ã«HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå­˜åœ¨",
        category="architecture",
        severity="critical",
        location="src/frontend/src/utils/api.ts, src/frontend/src/api/client.ts",
        fix_suggestion="src/core/http/client.tsã«çµ±ä¸€",
    )

    print(f"Issue #{issue.id} created: {issue.title}")
    print(f"Open issues: {len(manager.get_open_issues())}")
