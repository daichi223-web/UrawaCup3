# ギャップ分析：仕様書 vs 実装

## 概要

| フロー | 仕様書 | 実装 | ギャップ度 |
|--------|--------|------|-----------|
| 大会作成・設定 | 完全定義 | 部分実装 | 高 |
| チーム登録 | 完全定義 | ほぼ実装 | 中 |
| 選手登録 | 完全定義 | 未実装 | 高 |
| 試合日程生成 | 完全定義 | 実装済 | 低 |
| スコア入力 | 完全定義 | 部分実装 | 高 |
| 報告書作成 | 完全定義 | 部分実装 | 中 |

---

## 1. 大会作成・設定フロー

### ギャップ一覧

| # | 仕様 | 実装状況 | 重要度 | Issue |
|---|------|----------|--------|-------|
| 1 | 新規大会作成ボタン | ❌ 未実装 | 高 | #14 |
| 2 | 会場追加機能 | ❌ Toast「準備中」 | 高 | #15 |
| 3 | グループ自動生成 | ⚠️ 不明（要調査） | 中 | #16 |
| 4 | 状態遷移 Draft→TeamRegistration | ⚠️ 不明（要調査） | 中 | #17 |

---

## 2. チーム登録フロー

### ギャップ一覧

| # | 仕様 | 実装状況 | 重要度 | Issue |
|---|------|----------|--------|-------|
| 1 | CSV/Excelインポート | ❌ Toast「準備中」 | 高 | #18 |
| 2 | 列マッピング設定UI | ❌ 未実装 | 中 | #18 |
| 3 | インポートプレビュー | ❌ 未実装 | 中 | #18 |
| 4 | エラー行ハイライト | ❌ 未実装 | 低 | #18 |

---

## 3. 選手登録フロー

### ギャップ一覧

| # | 仕様 | 実装状況 | 重要度 | Issue |
|---|------|----------|--------|-------|
| 1 | 選手管理タブ（チーム詳細） | ❌ 未実装 | 高 | #19 |
| 2 | 参加申込書Excelインポート | ❌ Toast「準備中」 | 高 | #19 |
| 3 | フォーマット自動検出 | ❌ 未実装 | 中 | #19 |
| 4 | 個別選手追加フォーム | ❌ 未実装 | 中 | #19 |
| 5 | 選手一覧表示 | ❌ 未実装 | 高 | #19 |

---

## 4. 試合日程生成フロー

### ギャップ一覧

| # | 仕様 | 実装状況 | 重要度 | Issue |
|---|------|----------|--------|-------|
| 1 | 予選日程自動生成 | ✅ 実装済 | - | - |
| 2 | 決勝トーナメント生成 | ✅ 実装済 | - | - |
| 3 | 研修試合生成 | ✅ 実装済 | - | - |
| 4 | 手動調整（ドラッグ&ドロップ） | ⚠️ 不明（要調査） | 中 | #20 |
| 5 | 抽選結果入力UI | ⚠️ 不明（要調査） | 中 | #21 |

---

## 5. スコア入力フロー

### ギャップ一覧

| # | 仕様 | 実装状況 | 重要度 | Issue |
|---|------|----------|--------|-------|
| 1 | 基本スコア入力 | ✅ 実装済 | - | - |
| 2 | PK戦入力 | ✅ 実装済 | - | - |
| 3 | 得点者入力（サジェスト付き） | ❌ 未実装 | 高 | #22 |
| 4 | 排他ロック | ❌ 未実装 | 高 | #23 |
| 5 | 楽観的ロック（バージョン競合） | ❌ 未実装 | 高 | #23 |
| 6 | 競合解決ダイアログ | ❌ 未実装 | 中 | #23 |
| 7 | WebSocket リアルタイム更新 | ⚠️ 順位表のみ | 中 | #24 |

---

## 6. 報告書作成フロー

### ギャップ一覧

| # | 仕様 | 実装状況 | 重要度 | Issue |
|---|------|----------|--------|-------|
| 1 | PDF出力 | ✅ 実装済 | - | - |
| 2 | Excel出力 | ✅ 実装済 | - | - |
| 3 | バックグラウンドジョブ | ❌ 同期処理 | 低 | #25 |
| 4 | ポーリング進捗表示 | ❌ 未実装 | 低 | #25 |
| 5 | メール送信機能 | ❌ Coming Soon | 中 | #26 |
| 6 | 最終日組み合わせ表出力 | ⚠️ 不明（要調査） | 中 | #27 |
| 7 | 最終結果報告書出力 | ⚠️ 不明（要調査） | 中 | #27 |
| 8 | 優秀選手入力UI | ⚠️ 不明（要調査） | 中 | #27 |

---

## 優先度別サマリー

### 高優先度（必須機能）

1. **#19 選手管理機能** - 得点者サジェストの前提
2. **#22 得点者入力機能** - 報告書の得点経過に必要
3. **#23 排他ロック・バージョン競合** - 複数会場同時入力で必須
4. **#14 新規大会作成** - 毎年の大会作成に必要
5. **#15 会場追加** - 会場設定に必要
6. **#18 チームCSV/Excelインポート** - 24チーム登録の効率化

### 中優先度（推奨機能）

7. **#20 日程手動調整** - 運用の柔軟性
8. **#21 抽選結果入力UI** - 同率時の処理
9. **#24 WebSocket試合結果更新** - リアルタイム性向上
10. **#26 メール送信機能** - 報告書配信の効率化
11. **#27 最終日報告書** - 大会完了時に必要

### 低優先度（改善機能）

12. **#25 バックグラウンドジョブ** - UX改善
13. **#16 グループ自動生成確認** - 調査のみ
14. **#17 状態遷移確認** - 調査のみ

---

## 調査が必要な項目

以下は実装状況が不明なため、コード調査が必要：

1. グループ自動生成（大会作成時）
2. 大会状態遷移ロジック
3. 日程手動調整UI（ドラッグ&ドロップ）
4. 抽選結果入力UI
5. 最終日組み合わせ表生成
6. 最終結果報告書生成
7. 優秀選手入力UI

---

## 調査結果（2026-01-02）

### バックエンドAPI実装状況

| API | エンドポイント | 実装 | フロントエンド接続 |
|-----|---------------|------|-------------------|
| 大会作成 | POST /tournaments | ✅ 実装済 | ❌ 未接続 |
| 会場作成 | POST /venues | ✅ 実装済 | ❌ 未接続 |
| チームCSVインポート | POST /teams/import-csv | ✅ 実装済 | ❌ 未接続（Toastのみ） |
| 選手一覧 | GET /players | ✅ 実装済 | ⚠️ 部分接続 |
| 選手Excelインポート | POST /players/import-excel/{team_id}/preview, /import-excel/{team_id} | ✅ 実装済 | ❌ 未接続 |
| 得点者入力 | POST/PUT /matches/{id}/score (goals含む) | ✅ 実装済 | ❌ 未接続（goals:[]固定） |

### 発見事項

1. **チームCSVインポート (#18)**
   - バックエンド: `POST /teams/import-csv` 実装済み
   - フロントエンド: `teamApi.importCsv` と `useImportTeamsCsv` フック実装済み
   - 問題: `TeamManagement.tsx` でToast表示のみ。フックを接続するだけで動作可能

2. **選手管理 (#19)**
   - バックエンド: Player CRUD + Excelインポート 実装済み
   - フロントエンド: `playerApi` と hooks 実装済み
   - 問題: 選手管理UIコンポーネントが存在しない

3. **得点者入力 (#22)**
   - バックエンド: `PUT /matches/{id}/score` で goals 配列を受け付ける
   - フロントエンド: MatchResult.tsx の formData に `goals: []` が固定
   - 問題: 得点者入力フォームUIが未実装

### 優先対応項目

1. **即時対応可能**（コード変更のみ）
   - #18 チームCSVインポート接続
   
2. **UI追加が必要**
   - #19 選手管理画面の作成
   - #22 得点者入力フォームの追加
   - #14 新規大会作成画面
   - #15 会場追加モーダル

3. **要設計**
   - #23 排他ロック・バージョン競合（バックエンド拡張も必要）
