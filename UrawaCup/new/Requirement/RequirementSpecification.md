# 浦和カップ トーナメント管理システム 要件定義書

**バージョン**: 1.0
**作成日**: 2026-01-01
**最終更新**: 2026-01-01

---

## 目次

1. [システム概要](#1-システム概要)
2. [大会概要](#2-大会概要)
3. [機能要件](#3-機能要件)
4. [データモデル](#4-データモデル)
5. [画面一覧](#5-画面一覧)
6. [ユーザーと権限](#6-ユーザーと権限)
7. [技術スタック](#7-技術スタック)
8. [API設計](#8-api設計)
9. [制約事項・ビジネスルール](#9-制約事項ビジネスルール)
10. [非機能要件](#10-非機能要件)

---

## 1. システム概要

### 1.1 目的

浦和カップ高校サッカー大会の運営を効率化するためのWebアプリケーション。
試合日程の自動生成、リアルタイムの結果入力、順位表の自動計算、報告書の自動生成を行う。

### 1.2 対象ユーザー

| ユーザー種別 | 人数 | 主な操作 |
|--------------|------|----------|
| 大会運営者（管理者） | 2-3名 | 全機能 |
| 会場担当者 | 4名 | 担当会場の結果入力 |
| 閲覧者（一般公開） | 不特定 | 順位表・結果閲覧 |

### 1.3 システム構成

```
┌─────────────────────────────────────────────────────────┐
│                    フロントエンド                        │
│         React + TypeScript + Vite + TailwindCSS         │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                     バックエンド                         │
│              FastAPI + SQLAlchemy + SQLite              │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    データベース                          │
│                       SQLite                            │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 大会概要

### 2.1 大会形式

| 項目 | 内容 |
|------|------|
| 大会名 | 浦和カップ |
| 開催期間 | 3日間 |
| 参加チーム数 | 24チーム |
| グループ数 | 4グループ（A, B, C, D） |
| 1グループのチーム数 | 6チーム |

### 2.2 日程構成

| 日程 | 内容 | 試合数 |
|------|------|--------|
| Day1 | 予選リーグ前半 | 24試合（6試合×4会場） |
| Day2 | 予選リーグ後半 | 24試合（6試合×4会場） |
| Day3 | 決勝トーナメント＋研修試合 | 約24試合 |

### 2.3 チーム構成

| 区分 | チーム数 | 説明 |
|------|----------|------|
| 地元チーム | 9チーム | 埼玉県内の高校（会場担当校4校含む） |
| 招待チーム | 15チーム | 県外からの招待校 |
| **合計** | **24チーム** | |

### 2.4 会場担当校（固定配置）

| グループ | 1番チーム | 会場 |
|----------|-----------|------|
| A | 浦和南高校 | 浦和南高G |
| B | 市立浦和高校 | 市立浦和高G |
| C | 浦和学院高校 | 浦和学院G |
| D | 武南高校 | 武南高G |

---

## 3. 機能要件

### 3.1 大会管理

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-01 | 大会作成 | 新規大会の登録 | 高 |
| F-02 | 大会設定 | 試合時間、インターバル等の設定 | 高 |
| F-03 | グループ作成 | 4グループ（A,B,C,D）の自動作成 | 高 |

### 3.2 チーム管理

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-10 | チーム登録 | チーム情報の登録 | 高 |
| F-11 | チーム編集 | チーム情報の編集 | 高 |
| F-12 | グループ割当 | チームをグループに割り当て | 高 |
| F-13 | CSVインポート | チーム一括登録 | 中 |
| F-14 | 選手登録 | 選手情報の登録（得点者入力用） | 中 |

### 3.3 日程管理

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-20 | 対戦除外設定 | 変則リーグの除外ペア設定 | 高 |
| F-21 | 予選日程生成 | 48試合の自動生成 | 高 |
| F-22 | 決勝T生成 | 準決勝〜決勝の自動生成 | 高 |
| F-23 | 研修試合生成 | 2〜6位チームの試合生成 | 中 |
| F-24 | 日程編集 | 試合時間・会場の変更 | 中 |

### 3.4 結果入力

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-30 | スコア入力 | 前半・後半スコアの入力 | 高 |
| F-31 | PK戦入力 | PK戦スコアの入力 | 高 |
| F-32 | 得点者入力 | 得点者名・時間の入力 | 中 |
| F-33 | 入力ロック | 同時編集防止 | 高 |
| F-34 | 結果承認 | 管理者による結果承認 | 中 |

### 3.5 順位表・統計

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-40 | 順位表表示 | グループ別順位表 | 高 |
| F-41 | 順位自動計算 | 試合結果から自動計算 | 高 |
| F-42 | 得点ランキング | 得点者ランキング表示 | 中 |
| F-43 | 統計ダッシュボード | 試合数、得点数等の統計 | 低 |

### 3.6 レポート出力

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-50 | PDF出力 | 順位表・試合結果のPDF | 高 |
| F-51 | Excel出力 | データのExcel出力 | 中 |
| F-52 | 報告書送信 | 関係者への自動送信 | 低 |

### 3.7 公開機能

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-60 | 公開順位表 | 認証不要の順位表閲覧 | 高 |
| F-61 | 公開試合一覧 | 認証不要の試合結果閲覧 | 高 |
| F-62 | リアルタイム更新 | WebSocketによる自動更新 | 中 |

---

## 4. データモデル

### 4.1 ER図

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ Tournament  │────<│    Group    │────<│    Team     │
│   (大会)    │     │ (グループ)  │     │  (チーム)   │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    Venue    │────<│    Match    │────<│    Goal     │
│   (会場)    │     │   (試合)    │     │   (得点)    │
└─────────────┘     └─────────────┘     └─────────────┘
                           │                   │
                           ▼                   ▼
                    ┌─────────────┐     ┌─────────────┐
                    │  Standing   │     │   Player    │
                    │  (順位表)   │     │   (選手)    │
                    └─────────────┘     └─────────────┘
```

### 4.2 テーブル一覧

| テーブル | 説明 | 主キー | レコード目安 |
|----------|------|--------|-------------|
| tournaments | 大会 | id | 1件/年 |
| groups | グループ | (tournament_id, id) | 4件/大会 |
| teams | チーム | id | 24件/大会 |
| players | 選手 | id | 600-1200件/大会 |
| venues | 会場 | id | 4-5件/大会 |
| matches | 試合 | id | 約72件/大会 |
| goals | 得点 | id | 約200件/大会 |
| standings | 順位表 | id | 24件/大会 |
| exclusion_pairs | 除外ペア | id | 12件/大会 |
| users | ユーザー | id | 5-10件 |
| report_recipients | 送信先 | id | 4件/大会 |

### 4.3 主要テーブル定義

#### tournaments（大会）

| カラム | 型 | 説明 |
|--------|------|------|
| id | INTEGER | 主キー |
| name | VARCHAR(200) | 大会名 |
| edition | INTEGER | 開催回数（第○回） |
| year | INTEGER | 開催年度 |
| start_date | DATE | 開始日 |
| end_date | DATE | 終了日 |
| match_duration | INTEGER | 試合時間（分）デフォルト50 |
| half_duration | INTEGER | ハーフタイム（分）デフォルト25 |
| interval_minutes | INTEGER | 試合間隔（分）デフォルト15 |

#### teams（チーム）

| カラム | 型 | 説明 |
|--------|------|------|
| id | INTEGER | 主キー |
| tournament_id | INTEGER | 大会ID（FK） |
| name | VARCHAR(100) | チーム名 |
| short_name | VARCHAR(50) | 略称 |
| team_type | ENUM | 'local'（地元）/ 'invited'（招待） |
| is_venue_host | BOOLEAN | 会場担当校フラグ |
| group_id | VARCHAR(1) | グループID（A,B,C,D） |
| group_order | INTEGER | グループ内番号（1-6） |
| prefecture | VARCHAR(20) | 都道府県 |

#### matches（試合）

| カラム | 型 | 説明 |
|--------|------|------|
| id | INTEGER | 主キー |
| tournament_id | INTEGER | 大会ID（FK） |
| group_id | VARCHAR(1) | グループID |
| venue_id | INTEGER | 会場ID（FK） |
| home_team_id | INTEGER | ホームチームID（FK） |
| away_team_id | INTEGER | アウェイチームID（FK） |
| match_date | DATE | 試合日 |
| match_time | TIME | キックオフ時刻 |
| match_order | INTEGER | 試合順 |
| stage | ENUM | 試合ステージ |
| status | ENUM | ステータス |
| home_score_half1 | INTEGER | ホーム前半得点 |
| home_score_half2 | INTEGER | ホーム後半得点 |
| home_score_total | INTEGER | ホーム合計得点 |
| away_score_half1 | INTEGER | アウェイ前半得点 |
| away_score_half2 | INTEGER | アウェイ後半得点 |
| away_score_total | INTEGER | アウェイ合計得点 |
| home_pk | INTEGER | ホームPK得点 |
| away_pk | INTEGER | アウェイPK得点 |
| has_penalty_shootout | BOOLEAN | PK戦実施フラグ |
| result | ENUM | 試合結果 |

#### standings（順位表）

| カラム | 型 | 説明 |
|--------|------|------|
| id | INTEGER | 主キー |
| tournament_id | INTEGER | 大会ID（FK） |
| group_id | VARCHAR(1) | グループID |
| team_id | INTEGER | チームID（FK） |
| rank | INTEGER | 順位 |
| played | INTEGER | 試合数 |
| won | INTEGER | 勝利数 |
| drawn | INTEGER | 引分数 |
| lost | INTEGER | 敗北数 |
| goals_for | INTEGER | 総得点 |
| goals_against | INTEGER | 総失点 |
| goal_difference | INTEGER | 得失点差 |
| points | INTEGER | 勝点 |

### 4.4 Enum定義

#### MatchStage（試合ステージ）

| 値 | 説明 |
|----|------|
| preliminary | 予選リーグ |
| semifinal | 準決勝 |
| third_place | 3位決定戦 |
| final | 決勝 |
| training | 研修試合 |

#### MatchStatus（試合ステータス）

| 値 | 説明 |
|----|------|
| scheduled | 予定 |
| in_progress | 試合中 |
| completed | 完了 |
| cancelled | 中止 |

#### TeamType（チーム区分）

| 値 | 説明 |
|----|------|
| local | 地元チーム |
| invited | 招待チーム |

#### UserRole（ユーザー権限）

| 値 | 説明 |
|----|------|
| admin | 管理者 |
| venue_staff | 会場担当者 |
| viewer | 閲覧者 |

---

## 5. 画面一覧

### 5.1 管理者向け画面

| 画面ID | 画面名 | URL | 説明 |
|--------|--------|-----|------|
| S-01 | ログイン | /login | 認証画面 |
| S-02 | ダッシュボード | / | 統計サマリー |
| S-03 | チーム管理 | /teams | チーム一覧・編集 |
| S-04 | 日程管理 | /schedule | 試合日程の生成・編集 |
| S-05 | 結果入力 | /results | スコア入力 |
| S-06 | 順位表 | /standings | 順位表表示 |
| S-07 | 得点ランキング | /scorers | 得点者ランキング |
| S-08 | レポート | /reports | PDF/Excel出力 |
| S-09 | 設定 | /settings | システム設定 |
| S-10 | 除外設定 | /exclusions | 対戦除外ペア設定 |
| S-11 | 承認管理 | /approval | 結果承認 |

### 5.2 公開画面（認証不要）

| 画面ID | 画面名 | URL | 説明 |
|--------|--------|-----|------|
| P-01 | 公開順位表 | /public/standings | 一般公開用順位表 |
| P-02 | 公開試合一覧 | /public/matches | 一般公開用試合結果 |

---

## 6. ユーザーと権限

### 6.1 権限マトリックス

| 機能 | admin | venue_staff | viewer | 未認証 |
|------|-------|-------------|--------|--------|
| ダッシュボード閲覧 | ○ | ○ | ○ | × |
| チーム管理 | ○ | × | × | × |
| 日程生成 | ○ | × | × | × |
| 結果入力（全会場） | ○ | × | × | × |
| 結果入力（担当会場） | ○ | ○ | × | × |
| 順位表閲覧 | ○ | ○ | ○ | ○ |
| レポート出力 | ○ | × | × | × |
| 設定変更 | ○ | × | × | × |
| 結果承認 | ○ | × | × | × |

### 6.2 デフォルトユーザー

| ユーザー名 | パスワード | 権限 | 用途 |
|------------|------------|------|------|
| admin | admin1234 | admin | 管理者 |

---

## 7. 技術スタック

### 7.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|------------|------|
| React | 18.x | UIフレームワーク |
| TypeScript | 5.x | 型安全性 |
| Vite | 5.x | ビルドツール |
| TailwindCSS | 3.x | スタイリング |
| React Query | 5.x | データフェッチング |
| Zustand | 4.x | 状態管理 |
| React Router | 6.x | ルーティング |
| React Hot Toast | 2.x | 通知 |
| Playwright | 1.x | E2Eテスト |

### 7.2 バックエンド

| 技術 | バージョン | 用途 |
|------|------------|------|
| Python | 3.11+ | 言語 |
| FastAPI | 0.100+ | Webフレームワーク |
| SQLAlchemy | 2.x | ORM |
| SQLite | 3.x | データベース |
| Pydantic | 2.x | バリデーション |
| JWT | - | 認証 |
| Uvicorn | - | ASGIサーバー |

### 7.3 開発ツール

| ツール | 用途 |
|--------|------|
| ESLint | コード品質 |
| Prettier | コードフォーマット |
| pytest | バックエンドテスト |

---

## 8. API設計

### 8.1 エンドポイント一覧

#### 認証

| メソッド | パス | 説明 |
|----------|------|------|
| POST | /api/auth/login | ログイン |
| POST | /api/auth/logout | ログアウト |
| GET | /api/auth/me | 現在のユーザー情報 |

#### チーム

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/teams | チーム一覧 |
| POST | /api/teams | チーム作成 |
| GET | /api/teams/{id} | チーム詳細 |
| PATCH | /api/teams/{id} | チーム更新 |
| DELETE | /api/teams/{id} | チーム削除 |

#### 試合

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/matches | 試合一覧 |
| POST | /api/matches/generate-schedule/{tournament_id} | 予選日程生成 |
| POST | /api/matches/generate-finals/{tournament_id} | 決勝T生成 |
| POST | /api/matches/generate-training/{tournament_id} | 研修試合生成 |
| PUT | /api/matches/{id}/score | スコア入力 |
| POST | /api/matches/{id}/lock | ロック取得 |
| DELETE | /api/matches/{id}/lock | ロック解除 |

#### 順位表

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/standings | 順位表取得 |
| POST | /api/standings/recalculate/{tournament_id} | 再計算 |

#### 除外ペア

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/exclusions | 除外ペア一覧 |
| POST | /api/exclusions | 除外ペア作成 |
| DELETE | /api/exclusions/{id} | 除外ペア削除 |

### 8.2 API命名規則

- **リクエスト/レスポンス**: camelCase
- **バックエンド内部**: snake_case
- **変換**: Pydantic CamelCaseModel で自動変換

```python
# バックエンド（Python）
class TeamSchema(CamelCaseModel):
    tournament_id: int  # 内部はsnake_case
    group_id: str

# API レスポンス（JSON）
{
    "tournamentId": 1,  # 外部はcamelCase
    "groupId": "A"
}
```

---

## 9. 制約事項・ビジネスルール

### 9.1 変則リーグルール

```
6チームの変則リーグ:
- 通常の総当たり: 6C2 = 15試合
- 除外ペア: 3組
- 実際の試合数: 15 - 3 = 12試合/グループ
- 各チームの試合数: 4試合（2チームとは対戦しない）
```

### 9.2 除外ペアの選定基準

1. 地元校同士の対戦を避ける
2. 近い地域のチーム同士を避ける
3. 他大会で同じリーグのチーム同士を避ける

### 9.3 順位決定ルール

1. 勝点（勝利=3点、引分=1点、敗北=0点）
2. 得失点差
3. 総得点
4. 当該チーム間の対戦成績
5. 抽選

### 9.4 試合時間計算

```
1試合の所要時間 = 試合時間(50分) + インターバル(15分) = 65分

1日の試合数: 6試合/会場
開始時刻: 9:30
終了予定: 約16:00
```

### 9.5 決勝トーナメント組み合わせ

```
準決勝1: A1位 vs B1位
準決勝2: C1位 vs D1位
3位決定戦: 準決勝敗者同士
決勝: 準決勝勝者同士
```

### 9.6 研修試合組み合わせ

```
各グループ2〜6位のチームで実施
同順位同士かつ予選リーグで未対戦のチームを組み合わせ
```

---

## 10. 非機能要件

### 10.1 性能要件

| 項目 | 要件 |
|------|------|
| 同時接続数 | 50ユーザー以上 |
| レスポンス時間 | 3秒以内 |
| 可用性 | 大会期間中99%以上 |

### 10.2 セキュリティ要件

| 項目 | 要件 |
|------|------|
| 認証 | JWT トークン認証 |
| パスワード | bcrypt ハッシュ化 |
| HTTPS | 本番環境では必須 |
| CORS | 許可オリジンを限定 |

### 10.3 ブラウザ対応

| ブラウザ | バージョン |
|----------|------------|
| Chrome | 最新2バージョン |
| Firefox | 最新2バージョン |
| Safari | 最新2バージョン |
| Edge | 最新2バージョン |

### 10.4 モバイル対応

- レスポンシブデザイン対応
- 最小幅: 375px（iPhone SE）

---

## 付録

### A. 関連ドキュメント

| ドキュメント | パス | 説明 |
|--------------|------|------|
| エラー分析 | Issue/ErrorAnalysis.md | 発生したエラーと解決策 |
| 根本原因分析 | Issue/RootCauseAnalysis.md | アーキテクチャ上の課題 |
| DB構造 | Issue/DatabaseStructure.md | データベース詳細設計 |

### B. 用語集

| 用語 | 説明 |
|------|------|
| 変則リーグ | 総当たりから一部対戦を除外したリーグ戦 |
| 除外ペア | 対戦しないチームの組み合わせ |
| 会場担当校 | 各グループの1番チームで、会場を提供する学校 |
| 研修試合 | Day3に行われる2〜6位チームの練習試合 |

### C. 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026-01-01 | 初版作成 |
