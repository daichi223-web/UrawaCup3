# 最終日組み合わせ画面 詳細仕様

## 1. 編集可能な項目一覧

| 項目 | 編集方法 | 備考 |
|------|----------|------|
| キックオフ時間 | ドロップダウン or 時間入力 | 5分刻み |
| 対戦チーム（ホーム） | ドロップダウン / DnD | - |
| 対戦チーム（アウェイ） | ドロップダウン / DnD | - |
| 審判（主審） | ドロップダウン | 派遣/当該/チーム名 |
| 審判（副審） | ドロップダウン | 派遣/当該/チーム名 |
| 会場担当 | ドロップダウン | チーム選択 |
| 試合の追加 | ボタン | 行追加 |
| 試合の削除 | ボタン | 行削除 |

---

## 2. 画面レイアウト

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  最終日組み合わせ                                    [自動生成] [保存]      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  3月31日（日）【順位リーグ】                                                │
│                                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌───────────────┐
│  │   浦和南高G     │ │  市立浦和高G    │ │  浦和学院高G    │ │    武南高G    │
│  │   (4会場)       │ │                 │ │                 │ │               │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ └───────────────┘
│                                                                             │
│  3月31日（日）【3決・決勝戦】                                               │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                        駒場スタジアム                                  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 会場カード（詳細）

```
┌─────────────────────────────────────────────────────────────────┐
│  浦和南高G                                          [＋試合追加] │
├──────┬─────────────────────────────┬────────────────┬──────────┤
│  KO  │          対 戦              │     審 判      │          │
├──────┼─────────────────────────────┼────────────────┼──────────┤
│      │                             │                │          │
│[9:30▼]│ [4位③ ▼] - [5位① ▼]       │ 主[当該▼]      │  [🗑️]   │
│      │  ≡ DnD    ≡ DnD            │ 副[当該▼]      │          │
│      │                             │                │          │
├──────┼─────────────────────────────┼────────────────┼──────────┤
│      │                             │                │          │
│[10:35▼]│ [明秀日立▼] - [日本文理▼]│ 主[当該▼]      │  [🗑️]   │
│      │  ≡ DnD      ≡ DnD          │ 副[当該▼]      │          │
│      │                             │                │          │
├──────┼─────────────────────────────┼────────────────┼──────────┤
│      │                             │                │          │
│[11:40▼]│ [健大高崎▼] - [浦和南▼]  │ 主[当該▼]      │  [🗑️]   │
│      │                             │                │          │
├──────┼─────────────────────────────┼────────────────┼──────────┤
│      │       ... (続く)            │                │          │
├──────┴─────────────────────────────┴────────────────┴──────────┤
│  会場担当: [浦和南 ▼]                                           │
└─────────────────────────────────────────────────────────────────┘

凡例:
[▼] = ドロップダウン（クリックで選択肢表示）
≡   = ドラッグハンドル（DnDで入れ替え可能）
[🗑️] = 削除ボタン
```

### 2.3 駒場スタジアム（決勝T）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  駒場スタジアム（RHF駒場）                                    [＋試合追加]  │
├──────┬────────┬─────────────────────────────┬────────────────┬─────────────┤
│  KO  │  種別  │          対 戦              │     審 判      │             │
├──────┼────────┼─────────────────────────────┼────────────────┼─────────────┤
│[9:00▼]│  研修 │[ツエーゲン金沢▼]-[浦和RY▼] │主[派遣▼]副[当該▼]│   [🗑️]    │
├──────┼────────┼─────────────────────────────┼────────────────┼─────────────┤
│[10:05▼]│ 研修 │[PHM相模原▼]-[アイシン▼]    │主[当該▼]副[当該▼]│   [🗑️]    │
├──────┼────────┼─────────────────────────────┼────────────────┼─────────────┤
│[12:00▼]│ 3位決│[準決1敗者  ] - [準決2敗者  ]│主[派遣▼]副[派遣▼]│   🔒       │
│      │       │  (自動決定)     (自動決定)   │                │             │
├──────┼────────┼─────────────────────────────┼────────────────┼─────────────┤
│[13:05▼]│ 決勝 │[準決1勝者  ] - [準決2勝者  ]│主[派遣▼]副[派遣▼]│   🔒       │
│      │       │  (自動決定)     (自動決定)   │                │             │
├──────┴────────┴─────────────────────────────┴────────────────┴─────────────┤
│  会場担当: [浦和RY ▼]                                                       │
└─────────────────────────────────────────────────────────────────────────────┘

🔒 = 削除不可（3位決・決勝は必須）
```

---

## 3. 各編集項目の詳細

### 3.1 キックオフ時間

```
選択肢（ドロップダウン）:
├── 9:00
├── 9:30
├── 10:00
├── 10:05
├── 10:35
├── 11:00
├── 11:10
├── 11:40
├── 12:00
├── 12:45
├── 13:00
├── 13:05
├── 13:50
└── カスタム入力...

※ 5分刻みで選択可能
※ カスタム入力も可能
```

### 3.2 対戦チーム

```
ドロップダウンの選択肢:

【シード（順位）】
├── A1位 (浦和南)
├── A2位 (市立浦和)
├── ...
├── B1位 (浦和学院)
├── ...
├── 3位① (チーム名)
├── 3位② (チーム名)
├── 4位① (チーム名)
├── 4位② (チーム名)
├── 5位① (チーム名)
├── 6位① (チーム名)
└── ...

【全チーム】（検索可能）
├── 浦和南
├── 市立浦和
├── 浦和学院
├── 武南
├── 明秀日立
├── 健大高崎
└── ...

※ DnDで別の枠と入れ替え可能
```

### 3.3 審判

```
ドロップダウンの選択肢:

├── 派遣        ← 協会から派遣
├── 当該        ← 対戦チームが担当
├── ────────────
├── 浦和南
├── 市立浦和
├── 浦和学院
├── 武南
├── 明秀日立
└── ...         ← 全チームリスト
```

### 3.4 会場担当

```
ドロップダウンの選択肢:

├── 浦和南
├── 市立浦和
├── 浦和学院
├── 武南
├── 浦和RY
└── ...         ← 全チームリスト
```

### 3.5 試合追加

```
[＋試合追加] ボタンクリック
    ↓
┌───────────────────────────────────────┐
│  試合追加                        [×] │
├───────────────────────────────────────┤
│                                       │
│  キックオフ: [14:00 ▼]               │
│                                       │
│  ホーム:     [チーム選択 ▼]          │
│                                       │
│  アウェイ:   [チーム選択 ▼]          │
│                                       │
│  主審:       [当該 ▼]                │
│                                       │
│  副審:       [当該 ▼]                │
│                                       │
│            [キャンセル] [追加]        │
└───────────────────────────────────────┘
```

### 3.6 試合削除

```
[🗑️] ボタンクリック
    ↓
┌───────────────────────────────────────┐
│  確認                                 │
├───────────────────────────────────────┤
│                                       │
│  この試合を削除しますか？             │
│                                       │
│  9:30 4位③ vs 5位①                  │
│                                       │
│            [キャンセル] [削除]        │
└───────────────────────────────────────┘

※ 3位決・決勝は削除不可（🔒表示）
```

---

## 4. DnD（ドラッグ＆ドロップ）仕様

### 4.1 基本動作

```
【入れ替え操作】

1. チーム枠をドラッグ開始
   ┌──────────┐
   │ 4位③ ≡  │ ← マウスダウン / 長押し
   └──────────┘

2. ドラッグ中
   ┌ ─ ─ ─ ─ ─┐     ┌──────────┐
   │ 4位③    │ ──► │ 5位① ≡  │ ← ドロップ先がハイライト
   └ ─ ─ ─ ─ ─┘     └──────────┘
     半透明           緑の枠線

3. ドロップ
   ┌──────────┐     ┌──────────┐
   │ 5位① ≡  │     │ 4位③ ≡  │ ← 入れ替え完了
   └──────────┘     └──────────┘
```

### 4.2 DnD可能な範囲

```
✅ 同じ会場内のチーム同士
✅ 異なる会場のチーム同士
✅ 研修試合 ⇔ 研修試合
✅ 準決勝のチーム（A1 vs C1 の組み合わせ変更）

❌ 3位決・決勝の「勝者」「敗者」枠（自動決定）
❌ 結果入力済みの試合
```

### 4.3 視覚的フィードバック

```css
/* 通常状態 */
.team-slot {
  border: 1px solid #ccc;
  background: white;
  cursor: grab;
}

/* ドラッグ中（元の位置） */
.team-slot.dragging {
  opacity: 0.5;
  border: 2px dashed #3b82f6;
}

/* ドロップ可能（ホバー中） */
.team-slot.drop-target {
  border: 2px solid #22c55e;
  background: #f0fdf4;
}

/* ドロップ不可 */
.team-slot.disabled {
  opacity: 0.6;
  cursor: not-allowed;
  background: #f3f4f6;
}
```

---

## 5. データ構造

### 5.1 最終日試合（FinalDayMatch）

```typescript
interface FinalDayMatch {
  id: string;
  tournamentId: number;
  venueId: number;
  kickoffTime: string;           // "9:30"
  matchType: 'training' | 'semifinal1' | 'semifinal2' | 'third_place' | 'final';
  displayOrder: number;
  
  // チーム（どちらかが設定される）
  homeTeamId: number | null;     // 確定時
  awayTeamId: number | null;
  homeSeed: string | null;       // "A1", "4位③", "SF1勝者"
  awaySeed: string | null;
  
  // 審判
  refereeMain: string;           // "派遣", "当該", チーム名
  refereeAssistant: string;
  
  // 結果（入力後）
  homeScore: number | null;
  awayScore: number | null;
  status: 'scheduled' | 'completed';
}
```

### 5.2 会場スケジュール（VenueSchedule）

```typescript
interface VenueSchedule {
  venueId: number;
  venueName: string;
  venueManager: string;          // 会場担当チーム名
  matches: FinalDayMatch[];
}
```

### 5.3 最終日全体（FinalDaySchedule）

```typescript
interface FinalDaySchedule {
  tournamentId: number;
  date: string;                  // "2025-03-31"
  trainingVenues: VenueSchedule[];  // 研修試合（4会場）
  knockoutVenue: VenueSchedule;     // 決勝T（駒場）
}
```

---

## 6. API

### 6.1 取得

```yaml
GET /tournaments/{id}/final-day-schedule

Response:
{
  "tournamentId": 1,
  "date": "2025-03-31",
  "trainingVenues": [
    {
      "venueId": 1,
      "venueName": "浦和南高G",
      "venueManager": "浦和南",
      "matches": [
        {
          "id": "fd-001",
          "kickoffTime": "9:30",
          "matchType": "training",
          "homeSeed": "4位③",
          "awaySeed": "5位①",
          "homeTeamId": 10,
          "awayTeamId": 15,
          "refereeMain": "当該",
          "refereeAssistant": "当該",
          "status": "scheduled"
        },
        ...
      ]
    },
    ...
  ],
  "knockoutVenue": {
    "venueId": 5,
    "venueName": "駒場スタジアム",
    "venueManager": "浦和RY",
    "matches": [...]
  }
}
```

### 6.2 自動生成

```yaml
POST /tournaments/{id}/final-day-schedule/generate

Response: FinalDaySchedule（生成された組み合わせ）
```

### 6.3 一括保存

```yaml
PUT /tournaments/{id}/final-day-schedule

Request: FinalDaySchedule

Response: { "success": true }
```

### 6.4 試合追加

```yaml
POST /tournaments/{id}/final-day-matches

Request:
{
  "venueId": 1,
  "kickoffTime": "14:00",
  "matchType": "training",
  "homeTeamId": 10,
  "awayTeamId": 15,
  "refereeMain": "当該",
  "refereeAssistant": "当該"
}

Response: FinalDayMatch
```

### 6.5 試合更新

```yaml
PATCH /final-day-matches/{matchId}

Request:
{
  "kickoffTime": "10:00",        // 変更したい項目のみ
  "homeTeamId": 20,
  "refereeMain": "派遣"
}

Response: FinalDayMatch
```

### 6.6 試合削除

```yaml
DELETE /final-day-matches/{matchId}

Response: { "success": true }
```

### 6.7 チーム入れ替え

```yaml
POST /final-day-matches/swap

Request:
{
  "match1Id": "fd-001",
  "side1": "home",
  "match2Id": "fd-005",
  "side2": "away"
}

Response:
{
  "match1": FinalDayMatch,
  "match2": FinalDayMatch
}
```

### 6.8 会場担当更新

```yaml
PATCH /tournaments/{id}/final-day-venues/{venueId}

Request:
{
  "venueManager": "市立浦和"
}

Response: { "success": true }
```

---

## 7. コンポーネント構成

```
FinalDaySchedulePage
├── PageHeader
│   ├── Title ("最終日組み合わせ")
│   ├── GenerateButton
│   └── SaveButton
│
├── DndContext (単一のコンテキストで全体を囲む)
│   │
│   ├── TrainingSection ("順位リーグ")
│   │   └── VenueCard × 4
│   │       ├── VenueHeader (会場名 + 追加ボタン)
│   │       ├── MatchTable
│   │       │   └── MatchRow × n
│   │       │       ├── KickoffTimeSelect
│   │       │       ├── TeamSlot (home) ← DnD対応
│   │       │       ├── TeamSlot (away) ← DnD対応
│   │       │       ├── RefereeSelect (main)
│   │       │       ├── RefereeSelect (assistant)
│   │       │       └── DeleteButton
│   │       └── VenueManagerSelect
│   │
│   └── KnockoutSection ("3決・決勝戦")
│       └── KnockoutCard
│           ├── VenueHeader
│           ├── MatchTable
│           │   └── KnockoutMatchRow × n
│           │       ├── KickoffTimeSelect
│           │       ├── MatchTypeLabel (研修/3位決/決勝)
│           │       ├── TeamSlot (home)
│           │       ├── TeamSlot (away)
│           │       ├── RefereeSelect × 2
│           │       └── DeleteButton (3決/決勝は非表示)
│           └── VenueManagerSelect
│
├── DragOverlay (createPortal → document.body)
│   └── TeamSlotPreview
│
└── AddMatchModal
```

---

## 8. 実装チェックリスト

### 画面
- [ ] 4会場のカード表示
- [ ] 駒場スタジアムのカード表示
- [ ] 各試合の行表示

### 編集機能
- [ ] キックオフ時間ドロップダウン
- [ ] チーム選択ドロップダウン
- [ ] 審判選択ドロップダウン
- [ ] 会場担当選択ドロップダウン
- [ ] 試合追加モーダル
- [ ] 試合削除（確認付き）

### DnD
- [ ] 単一DndContextで全体を囲む
- [ ] TeamSlotがドラッグ＆ドロップ可能
- [ ] DragOverlayをcreatePortalでbodyに
- [ ] 二重実行防止（useRef）
- [ ] 視覚的フィードバック

### API連携
- [ ] 初期データ取得
- [ ] 自動生成
- [ ] 一括保存
- [ ] チーム入れ替え
- [ ] 試合追加/削除
- [ ] 会場担当更新

### バリデーション
- [ ] 3決・決勝は削除不可
- [ ] 結果入力済みは編集不可
- [ ] 必須項目チェック
