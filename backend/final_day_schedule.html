<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ¦å’Œã‚«ãƒƒãƒ— - æœ€çµ‚æ—¥çµ„ã¿åˆã‚ã›</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #1a365d;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        
        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #1a365d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ */
        .file-input-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-input-area:hover {
            border-color: #2b6cb0;
            background: #ebf8ff;
        }
        .file-input-area.loaded {
            border-color: #38a169;
            background: #f0fff4;
        }
        #fileInput {
            display: none;
        }
        
        /* é †ä½è¡¨ã‚°ãƒªãƒƒãƒ‰ */
        .standings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .standings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .standings-table th,
        .standings-table td {
            padding: 5px 4px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .standings-table th {
            background: #2b6cb0;
            color: white;
        }
        .standings-table .team-col {
            text-align: left;
        }
        .rank-1 { background: #fef3c7 !important; }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #2b6cb0;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background: #2c5282;
        }
        .btn-secondary {
            background: #e2e8f0;
            color: #1a365d;
        }
        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }
        .btn-success {
            background: #38a169;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #2f855a;
        }
        .btn-warning {
            background: #dd6b20;
            color: white;
        }
        .btn-warning:hover:not(:disabled) {
            background: #c05621;
        }
        
        /* å…¥ã‚Œæ›¿ãˆãƒ¢ãƒ¼ãƒ‰ */
        .swap-mode-indicator {
            display: none;
            padding: 15px;
            background: #fef3c7;
            border-radius: 8px;
            margin-bottom: 15px;
            align-items: center;
            gap: 15px;
        }
        .swap-mode-indicator.active {
            display: flex;
        }
        .swap-mode-indicator .message {
            flex: 1;
            font-weight: bold;
            color: #744210;
        }
        
        /* æ±ºå‹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ */
        .tournament-bracket {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .tournament-match {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            text-align: center;
        }
        .tournament-match.final {
            border-color: #d69e2e;
            background: #fffff0;
        }
        .tournament-match .match-type {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }
        .tournament-match .teams {
            font-size: 14px;
            font-weight: bold;
        }
        .tournament-match .kickoff {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* ç ”ä¿®è©¦åˆãƒ†ãƒ¼ãƒ–ãƒ« */
        .venue-section {
            margin-bottom: 20px;
        }
        .venue-title {
            font-size: 14px;
            font-weight: bold;
            color: #2b6cb0;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #ebf8ff;
            border-radius: 5px;
        }
        .match-table {
            width: 100%;
            border-collapse: collapse;
        }
        .match-table th,
        .match-table td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .match-table th {
            background: #4a5568;
            color: white;
            font-size: 12px;
        }
        .match-table .team-cell {
            font-weight: bold;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .match-table .team-cell:hover {
            background: #ebf8ff;
        }
        .match-table .team-cell.selected {
            background: #fef3c7;
            outline: 2px solid #d69e2e;
        }
        .match-table .team-cell.swap-target {
            background: #c6f6d5;
        }
        .match-table .team-cell.highlight-changed {
            background: #90cdf4;
            animation: highlight-fade-blue 3s ease-out;
        }
        @keyframes highlight-fade-blue {
            0% { background: #63b3ed; }
            70% { background: #90cdf4; }
            100% { background: transparent; }
        }
        .match-table tr.has-warning .team-cell {
            background: #fed7aa;
        }
        .match-table tr.has-warning .team-cell.selected {
            background: #fef3c7;
            outline: 2px solid #d69e2e;
        }
        .match-table .seed {
            font-size: 11px;
            color: #666;
        }
        .match-table .warning {
            color: #c53030;
            font-size: 12px;
        }
        .match-table .btn-change {
            padding: 4px 10px;
            font-size: 11px;
            background: #e2e8f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .match-table .btn-change:hover {
            background: #cbd5e0;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            max-width: 450px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #1a365d;
        }
        .modal-subtitle {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }
        .opponent-list {
            list-style: none;
        }
        .opponent-item {
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .opponent-item:hover:not(.disabled) {
            background: #ebf8ff;
            border-color: #2b6cb0;
        }
        .opponent-item.current {
            background: #ebf8ff;
            border-color: #2b6cb0;
        }
        .opponent-item.recommended {
            background: #f0fff4;
            border-color: #38a169;
        }
        .opponent-item.disabled {
            background: #f7fafc;
            color: #a0aec0;
            cursor: not-allowed;
        }
        .opponent-item .badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .badge-current {
            background: #bee3f8;
            color: #2b6cb0;
        }
        .badge-recommended {
            background: #c6f6d5;
            color: #276749;
        }
        .badge-played {
            background: #fed7d7;
            color: #c53030;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        /* èª¬æ˜ */
        .help-text {
            font-size: 13px;
            color: #666;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>ğŸ† æµ¦å’Œã‚«ãƒƒãƒ— - æœ€çµ‚æ—¥çµ„ã¿åˆã‚ã›</h1>
    <p class="subtitle">ç¬¬44å›æµ¦å’Œã‚«ãƒƒãƒ—é«˜æ ¡ã‚µãƒƒã‚«ãƒ¼ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ã€€3æœˆ31æ—¥ï¼ˆæœˆï¼‰</p>
    
    <!-- Step 1: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <div class="section" id="step1">
        <div class="section-title">ğŸ“‚ Step 1: äºˆé¸çµæœã‚’èª­ã¿è¾¼ã‚€</div>
        <div class="file-input-area" id="fileInputArea" onclick="document.getElementById('fileInput').click()">
            <p>ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
            <p style="font-size: 12px; color: #666; margin-top: 10px;">
                ï¼ˆmatch_input.htmlã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
            </p>
        </div>
        <input type="file" id="fileInput" accept=".json" onchange="loadJSON(this)">
        <div style="margin-top: 15px; text-align: center;">
            <button class="btn btn-secondary" onclick="loadSampleData()">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§è©¦ã™</button>
        </div>
    </div>
    
    <!-- Step 2: é †ä½è¡¨ -->
    <div class="section" id="step2" style="display: none;">
        <div class="section-title">ğŸ“Š Step 2: äºˆé¸é †ä½è¡¨ã®ç¢ºèª</div>
        <div class="standings-grid" id="standingsContainer"></div>
        <div class="actions" style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="generateSchedule()">
                âš¡ æœ€çµ‚æ—¥çµ„ã¿åˆã‚ã›ã‚’è‡ªå‹•ç”Ÿæˆ
            </button>
        </div>
    </div>
    
    <!-- Step 3: çµ„ã¿åˆã‚ã›è¡¨ -->
    <div class="section" id="step3" style="display: none;">
        <div class="section-title">ğŸ“‹ Step 3: æœ€çµ‚æ—¥çµ„ã¿åˆã‚ã›</div>
        
        <div class="help-text">
            âš ï¸ ãƒãƒ¼ã‚¯ãŒã‚ã‚‹è©¦åˆã¯äºˆé¸ã§å¯¾æˆ¦æ¸ˆã¿ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚<br>
            <strong>æ“ä½œæ–¹æ³•ï¼š</strong><br>
            ãƒ»ãƒãƒ¼ãƒ åã‚’2ã¤ã‚¯ãƒªãƒƒã‚¯ â†’ å…¥ã‚Œæ›¿ãˆ<br>
            ãƒ»[å¤‰æ›´]ãƒœã‚¿ãƒ³ â†’ ãã®ãƒãƒ¼ãƒ ã‚’åˆ¥ã®è©¦åˆã«ç§»å‹•
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="generateSchedule()">
                âš¡ å†ç”Ÿæˆ
            </button>
        </div>
        
        <div class="swap-mode-indicator active" id="swapIndicator">
            <span class="message" id="swapMessage">ãƒãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥ã‚Œæ›¿ãˆï¼ˆ2ã¤é¸æŠï¼‰</span>
            <button class="btn btn-secondary" onclick="cancelSwap()" id="cancelBtn" style="display:none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        
        <!-- æ±ºå‹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ -->
        <div class="section-title" style="margin-top: 20px;">ğŸ† æ±ºå‹ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ @ é§’å ´ã‚¹ã‚¿ã‚¸ã‚¢ãƒ </div>
        <div id="tournamentContainer"></div>
        
        <!-- ç ”ä¿®è©¦åˆ -->
        <div class="section-title" style="margin-top: 30px;">âš½ ç ”ä¿®è©¦åˆ</div>
        <div id="trainingContainer"></div>
        
        <div class="actions" style="margin-top: 30px;">
            <button class="btn btn-success" onclick="exportSchedule()">
                ğŸ“¤ çµ„ã¿åˆã‚ã›JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            </button>
        </div>
    </div>
    
    <!-- å¯¾æˆ¦ç›¸æ‰‹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="changeModal">
        <div class="modal-content">
            <div class="modal-title">ç§»å‹•å…ˆã‚’é¸æŠ</div>
            <div class="modal-subtitle" id="changeModalSubtitle"></div>
            <ul class="opponent-list" id="opponentList"></ul>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeChangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================================================
        // è¨­å®š
        // =============================================================================
        const CONFIG = {
            groups: ['A', 'B', 'C', 'D'],
            teamsPerGroup: 6,
            venues: ['æµ¦å’Œå—é«˜G', 'å¸‚ç«‹æµ¦å’Œé«˜G', 'æµ¦å’Œå­¦é™¢é«˜G', 'æ­¦å—é«˜G'],
            kickoffTimes: ['9:30', '10:35', '11:40', '12:45', '13:50'],
            tournamentVenue: 'é§’å ´ã‚¹ã‚¿ã‚¸ã‚¢ãƒ ',
        };
        
        // =============================================================================
        // çŠ¶æ…‹
        // =============================================================================
        let loadedData = null;          // èª­ã¿è¾¼ã‚“ã äºˆé¸ãƒ‡ãƒ¼ã‚¿
        let standings = {};             // ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥é †ä½è¡¨
        let playedPairs = new Set();    // å¯¾æˆ¦æ¸ˆã¿ãƒšã‚¢
        let schedule = null;            // ç”Ÿæˆã—ãŸçµ„ã¿åˆã‚ã›
        let swapFirst = null;           // å…¥ã‚Œæ›¿ãˆ1ã¤ç›® {type, matchId, position}
        
        // =============================================================================
        // Step 1: JSONèª­ã¿è¾¼ã¿
        // =============================================================================
        function loadJSON(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    processLoadedData(data);
                } catch (err) {
                    alert('JSONã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function loadSampleData() {
            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            const sampleData = {
                standings: [
                    { group: 'A', teams: [
                        { id: 1, name: 'æµ¦å’Œå—', rank: 1, points: 12, goalDiff: 5, goalsFor: 8 },
                        { id: 2, name: 'æ±æµ·å¤§ç›¸æ¨¡', rank: 2, points: 9, goalDiff: 3, goalsFor: 6 },
                        { id: 3, name: 'å¥å¤§é«˜å´', rank: 3, points: 6, goalDiff: 0, goalsFor: 4 },
                        { id: 4, name: 'å°‚å¤§åŒ—ä¸Š', rank: 4, points: 4, goalDiff: -2, goalsFor: 3 },
                        { id: 5, name: 'æ—¥æœ¬æ–‡ç†', rank: 5, points: 2, goalDiff: -3, goalsFor: 2 },
                        { id: 6, name: 'æ–°æ½Ÿè¥¿', rank: 6, points: 1, goalDiff: -5, goalsFor: 1 },
                    ]},
                    { group: 'B', teams: [
                        { id: 7, name: 'å¸‚ç«‹æµ¦å’Œ', rank: 1, points: 11, goalDiff: 4, goalsFor: 7 },
                        { id: 8, name: 'å¯Œå£«å¸‚ç«‹', rank: 2, points: 9, goalDiff: 3, goalsFor: 6 },
                        { id: 9, name: 'æ—­å·å®Ÿæ¥­', rank: 3, points: 6, goalDiff: 1, goalsFor: 5 },
                        { id: 10, name: 'RBå¤§å®®', rank: 4, points: 4, goalDiff: -1, goalsFor: 3 },
                        { id: 11, name: 'è–å’Œå­¦åœ’', rank: 5, points: 3, goalDiff: -3, goalsFor: 2 },
                        { id: 12, name: 'å¸äº¬å¤§å¯å…', rank: 6, points: 1, goalDiff: -6, goalsFor: 1 },
                    ]},
                    { group: 'C', teams: [
                        { id: 13, name: 'æµ¦å’Œå­¦é™¢', rank: 1, points: 10, goalDiff: 4, goalsFor: 7 },
                        { id: 14, name: 'æµ¦å’Œãƒ¬ãƒƒã‚º', rank: 2, points: 9, goalDiff: 3, goalsFor: 6 },
                        { id: 15, name: 'é‡è¾ºåœ°è¥¿', rank: 3, points: 7, goalDiff: 2, goalsFor: 5 },
                        { id: 16, name: 'ç£ç”°æ±', rank: 4, points: 4, goalDiff: -1, goalsFor: 3 },
                        { id: 17, name: 'æµ¦å’Œæ±', rank: 5, points: 2, goalDiff: -4, goalsFor: 2 },
                        { id: 18, name: 'æµ¦å’Œ', rank: 6, points: 1, goalDiff: -5, goalsFor: 1 },
                    ]},
                    { group: 'D', teams: [
                        { id: 19, name: 'æ­¦å—', rank: 1, points: 12, goalDiff: 6, goalsFor: 9 },
                        { id: 20, name: 'ä½é‡æ—¥å¤§', rank: 2, points: 8, goalDiff: 2, goalsFor: 5 },
                        { id: 21, name: 'éŸ®å´', rank: 3, points: 6, goalDiff: 1, goalsFor: 4 },
                        { id: 22, name: 'åœ‹å­¸é™¢ä¹…æˆ‘å±±', rank: 4, points: 5, goalDiff: 0, goalsFor: 4 },
                        { id: 23, name: 'æ—¥å¤§æ˜èª ', rank: 5, points: 3, goalDiff: -3, goalsFor: 2 },
                        { id: 24, name: 'æµ¦å’Œè¥¿', rank: 6, points: 0, goalDiff: -7, goalsFor: 0 },
                    ]},
                ]
            };
            processLoadedData(sampleData);
        }
        
        function processLoadedData(data) {
            loadedData = data;
            
            // é †ä½è¡¨ã‚’æ§‹ç¯‰
            standings = {};
            if (data.standings) {
                data.standings.forEach(g => {
                    standings[g.group] = g.teams.map((t, idx) => ({
                        ...t,
                        rank: t.rank || idx + 1,
                        group: g.group,
                    }));
                });
            }
            
            // å¯¾æˆ¦æ¸ˆã¿ãƒšã‚¢ã‚’æ§‹ç¯‰ï¼ˆåŒã‚°ãƒ«ãƒ¼ãƒ—å†…ã¯å…¨ã¦å¯¾æˆ¦æ¸ˆã¿ï¼‰
            playedPairs = new Set();
            Object.values(standings).forEach(teams => {
                for (let i = 0; i < teams.length; i++) {
                    for (let j = i + 1; j < teams.length; j++) {
                        const pair = [teams[i].id, teams[j].id].sort((a,b) => a-b).join('-');
                        playedPairs.add(pair);
                    }
                }
            });
            
            // UIæ›´æ–°
            document.getElementById('fileInputArea').classList.add('loaded');
            document.getElementById('fileInputArea').innerHTML = '<p>âœ“ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</p>';
            document.getElementById('step2').style.display = 'block';
            renderStandings();
        }
        
        // =============================================================================
        // Step 2: é †ä½è¡¨è¡¨ç¤º
        // =============================================================================
        function renderStandings() {
            const container = document.getElementById('standingsContainer');
            container.innerHTML = CONFIG.groups.map(group => {
                const teams = standings[group] || [];
                return `
                    <div>
                        <h4 style="color: #2b6cb0; margin-bottom: 8px;">ã‚°ãƒ«ãƒ¼ãƒ— ${group}</h4>
                        <table class="standings-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th class="team-col">ãƒãƒ¼ãƒ </th>
                                    <th>ç‚¹</th>
                                    <th>å·®</th>
                                    <th>å¾—</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${teams.map((t, idx) => `
                                    <tr class="${idx === 0 ? 'rank-1' : ''}">
                                        <td>${t.rank}</td>
                                        <td class="team-col">${t.name}</td>
                                        <td><strong>${t.points}</strong></td>
                                        <td>${t.goalDiff > 0 ? '+' : ''}${t.goalDiff}</td>
                                        <td>${t.goalsFor}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
        }
        
        // =============================================================================
        // Step 3: çµ„ã¿åˆã‚ã›ç”Ÿæˆ
        // =============================================================================
        function generateSchedule() {
            schedule = {
                tournament: generateTournament(),
                training: generateTraining(),
            };
            
            document.getElementById('step3').style.display = 'block';
            renderSchedule();
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateTournament() {
            const a1 = standings['A'][0];
            const b1 = standings['B'][0];
            const c1 = standings['C'][0];
            const d1 = standings['D'][0];
            
            return [
                { id: 'sf1', type: 'æº–æ±ºå‹1', home: a1, away: c1, kickoff: '9:30', venue: CONFIG.tournamentVenue },
                { id: 'sf2', type: 'æº–æ±ºå‹2', home: b1, away: d1, kickoff: '9:30', venue: CONFIG.tournamentVenue },
                { id: '3rd', type: '3ä½æ±ºå®šæˆ¦', home: null, away: null, homeSeed: 'SF1æ•—è€…', awaySeed: 'SF2æ•—è€…', kickoff: '12:00', venue: CONFIG.tournamentVenue },
                { id: 'final', type: 'æ±ºå‹', home: null, away: null, homeSeed: 'SF1å‹è€…', awaySeed: 'SF2å‹è€…', kickoff: '13:30', venue: CONFIG.tournamentVenue },
            ];
        }
        
        function generateTraining() {
            const matches = [];
            let matchId = 1;
            
            // 2ã€œ6ä½ã®ãƒãƒ¼ãƒ ã‚’å–å¾—
            const teamsByRank = {};
            for (let rank = 2; rank <= CONFIG.teamsPerGroup; rank++) {
                teamsByRank[rank] = CONFIG.groups.map(g => standings[g][rank - 1]);
            }
            
            // ãƒ©ã‚¦ãƒ³ãƒ‰1: A vs C, B vs D
            for (let rank = 2; rank <= CONFIG.teamsPerGroup; rank++) {
                const teams = teamsByRank[rank];
                matches.push(createMatch(matchId++, teams[0], teams[2])); // A vs C
                matches.push(createMatch(matchId++, teams[1], teams[3])); // B vs D
            }
            
            // ãƒ©ã‚¦ãƒ³ãƒ‰2: A vs D, B vs Cï¼ˆã‚¯ãƒ­ã‚¹ï¼‰
            for (let rank = 2; rank <= CONFIG.teamsPerGroup; rank++) {
                const teams = teamsByRank[rank];
                matches.push(createMatch(matchId++, teams[0], teams[3])); // A vs D
                matches.push(createMatch(matchId++, teams[1], teams[2])); // B vs C
            }
            
            // ä¼šå ´ãƒ»æ™‚é–“ã‚’å‰²ã‚Šå½“ã¦
            assignVenuesAndTimes(matches);
            
            return matches;
        }
        
        function createMatch(id, home, away) {
            const warning = isPlayed(home.id, away.id) ? 'âš ï¸ å¯¾æˆ¦æ¸ˆã¿' : '';
            return {
                id: `training-${id}`,
                home: home,
                away: away,
                venue: '',
                kickoff: '',
                warning: warning,
            };
        }
        
        function assignVenuesAndTimes(matches) {
            const venueCount = {};
            CONFIG.venues.forEach(v => venueCount[v] = 0);
            
            matches.forEach((match, idx) => {
                const venueIdx = idx % CONFIG.venues.length;
                const venue = CONFIG.venues[venueIdx];
                const timeIdx = venueCount[venue];
                
                match.venue = venue;
                match.kickoff = CONFIG.kickoffTimes[timeIdx] || '14:55';
                venueCount[venue]++;
            });
            
            // ä¼šå ´ãƒ»æ™‚é–“ã§ã‚½ãƒ¼ãƒˆ
            matches.sort((a, b) => {
                const venueOrder = CONFIG.venues.indexOf(a.venue) - CONFIG.venues.indexOf(b.venue);
                if (venueOrder !== 0) return venueOrder;
                return timeToMinutes(a.kickoff) - timeToMinutes(b.kickoff);
            });
        }
        
        function timeToMinutes(time) {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }
        
        function isPlayed(id1, id2) {
            const pair = [id1, id2].sort((a,b) => a-b).join('-');
            return playedPairs.has(pair);
        }
        
        // =============================================================================
        // çµ„ã¿åˆã‚ã›è¡¨ç¤º
        // =============================================================================
        function renderSchedule() {
            renderTournament();
            renderTraining();
        }
        
        function renderTournament() {
            const container = document.getElementById('tournamentContainer');
            
            // æº–æ±ºå‹ã®ã¿ç·¨é›†å¯èƒ½ã€3ä½æ±ºãƒ»æ±ºå‹ã¯çµæœã‹ã‚‰è‡ªå‹•
            const editableMatches = schedule.tournament.filter(m => m.id === 'sf1' || m.id === 'sf2');
            const autoMatches = schedule.tournament.filter(m => m.id === '3rd' || m.id === 'final');
            
            let html = `
                <table class="match-table" style="margin-bottom: 15px;">
                    <thead>
                        <tr>
                            <th style="width:60px">KO</th>
                            <th style="width:80px">ç¨®åˆ¥</th>
                            <th>ãƒ›ãƒ¼ãƒ </th>
                            <th style="width:30px"></th>
                            <th>ã‚¢ã‚¦ã‚§ã‚¤</th>
                            <th style="width:60px">å¯©åˆ¤</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // æº–æ±ºå‹ï¼ˆç·¨é›†å¯èƒ½ï¼‰
            editableMatches.forEach(m => {
                const homeName = m.home ? m.home.name : 'æœªå®š';
                const awayName = m.away ? m.away.name : 'æœªå®š';
                const homeSeed = m.home ? `${m.home.seed}` : '';
                const awaySeed = m.away ? `${m.away.seed}` : '';
                
                html += `
                    <tr data-match-id="${m.id}">
                        <td>${m.kickoff}</td>
                        <td>${m.type}</td>
                        <td>
                            <div class="team-cell" onclick="handleTeamClick('tournament', '${m.id}', 'home')"
                                 id="cell-tournament-${m.id}-home">
                                ${homeName}
                                <div class="seed">${homeSeed}</div>
                            </div>
                        </td>
                        <td>vs</td>
                        <td>
                            <div class="team-cell" onclick="handleTeamClick('tournament', '${m.id}', 'away')"
                                 id="cell-tournament-${m.id}-away">
                                ${awayName}
                                <div class="seed">${awaySeed}</div>
                            </div>
                        </td>
                        <td>æ´¾é£</td>
                    </tr>
                `;
            });
            
            // 3ä½æ±ºãƒ»æ±ºå‹ï¼ˆè‡ªå‹•ã€ç·¨é›†ä¸å¯ï¼‰
            autoMatches.forEach(m => {
                const homeName = m.home ? m.home.name : m.homeSeed;
                const awayName = m.away ? m.away.name : m.awaySeed;
                const rowClass = m.id === 'final' ? 'style="background:#fffff0;"' : '';
                
                html += `
                    <tr ${rowClass}>
                        <td>${m.kickoff}</td>
                        <td>${m.type}</td>
                        <td style="font-weight:bold;">${homeName}</td>
                        <td>vs</td>
                        <td style="font-weight:bold;">${awayName}</td>
                        <td>æ´¾é£</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        
        function renderTraining() {
            const container = document.getElementById('trainingContainer');
            
            // ä¼šå ´ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const byVenue = {};
            CONFIG.venues.forEach(v => byVenue[v] = []);
            schedule.training.forEach(m => {
                if (byVenue[m.venue]) byVenue[m.venue].push(m);
            });
            
            container.innerHTML = CONFIG.venues.map(venue => {
                const matches = byVenue[venue];
                if (matches.length === 0) return '';
                
                return `
                    <div class="venue-section">
                        <div class="venue-title">ğŸ“ ${venue}ï¼ˆ${matches.length}è©¦åˆï¼‰</div>
                        <table class="match-table">
                            <thead>
                                <tr>
                                    <th style="width:50px">KO</th>
                                    <th style="width:50px"></th>
                                    <th>ãƒ›ãƒ¼ãƒ </th>
                                    <th style="width:30px"></th>
                                    <th>ã‚¢ã‚¦ã‚§ã‚¤</th>
                                    <th style="width:50px"></th>
                                    <th style="width:70px">è­¦å‘Š</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${matches.map(m => {
                                    const rowClass = m.warning ? 'has-warning' : '';
                                    return `
                                    <tr data-match-id="${m.id}" class="${rowClass}">
                                        <td>${m.kickoff}</td>
                                        <td>
                                            <button class="btn-change" onclick="openChangeModal('${m.id}', 'home')">å¤‰æ›´</button>
                                        </td>
                                        <td>
                                            <div class="team-cell" onclick="handleTeamClick('training', '${m.id}', 'home')" 
                                                 id="cell-training-${m.id}-home">
                                                ${m.home.name}
                                                <div class="seed">${m.home.group}${m.home.rank}ä½</div>
                                            </div>
                                        </td>
                                        <td>vs</td>
                                        <td>
                                            <div class="team-cell" onclick="handleTeamClick('training', '${m.id}', 'away')"
                                                 id="cell-training-${m.id}-away">
                                                ${m.away.name}
                                                <div class="seed">${m.away.group}${m.away.rank}ä½</div>
                                            </div>
                                        </td>
                                        <td>
                                            <button class="btn-change" onclick="openChangeModal('${m.id}', 'away')">å¤‰æ›´</button>
                                        </td>
                                        <td class="warning">${m.warning}</td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }).join('');
        }
        
        // =============================================================================
        // å…¥ã‚Œæ›¿ãˆï¼ˆå¸¸æ™‚å‹•ä½œï¼‰
        // =============================================================================
        function cancelSwap() {
            swapFirst = null;
            clearSelection();
            document.getElementById('swapMessage').textContent = 'ãƒãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å…¥ã‚Œæ›¿ãˆï¼ˆ2ã¤é¸æŠï¼‰';
            document.getElementById('cancelBtn').style.display = 'none';
        }
        
        function clearSelection() {
            document.querySelectorAll('.team-cell.selected, .team-cell.swap-target').forEach(el => {
                el.classList.remove('selected', 'swap-target');
            });
        }
        
        function handleTeamClick(type, matchId, position) {
            const cellId = `cell-${type}-${matchId}-${position}`;
            const cell = document.getElementById(cellId);
            
            if (!swapFirst) {
                // 1ã¤ç›®ã‚’é¸æŠ
                swapFirst = { type, matchId, position };
                cell.classList.add('selected');
                document.getElementById('swapMessage').textContent = '2ã¤ç›®ã®ãƒãƒ¼ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯';
                document.getElementById('cancelBtn').style.display = 'inline-block';
            } else if (swapFirst.type === type && swapFirst.matchId === matchId && swapFirst.position === position) {
                // åŒã˜ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ è§£é™¤
                cancelSwap();
            } else {
                // 2ã¤ç›®ã‚’é¸æŠ â†’ å…¥ã‚Œæ›¿ãˆå®Ÿè¡Œ
                cell.classList.add('swap-target');
                executeSwap(swapFirst.type, swapFirst.matchId, swapFirst.position, type, matchId, position);
            }
        }
        
        function executeSwap(type1, matchId1, pos1, type2, matchId2, pos2) {
            // è©¦åˆã‚’å–å¾—
            const match1 = type1 === 'tournament' 
                ? schedule.tournament.find(m => m.id === matchId1)
                : schedule.training.find(m => m.id === matchId1);
            const match2 = type2 === 'tournament'
                ? schedule.tournament.find(m => m.id === matchId2)
                : schedule.training.find(m => m.id === matchId2);
            
            if (!match1 || !match2) {
                cancelSwap();
                return;
            }
            
            // å…¥ã‚Œæ›¿ãˆ
            const temp = match1[pos1];
            match1[pos1] = match2[pos2];
            match2[pos2] = temp;
            
            // è­¦å‘Šã‚’å†è¨ˆç®—ï¼ˆç ”ä¿®è©¦åˆã®ã¿ï¼‰
            if (type1 === 'training' && match1.home && match1.away) {
                match1.warning = isPlayed(match1.home.id, match1.away.id) ? 'âš ï¸ å¯¾æˆ¦æ¸ˆã¿' : '';
            }
            if (type2 === 'training' && match2.home && match2.away) {
                match2.warning = isPlayed(match2.home.id, match2.away.id) ? 'âš ï¸ å¯¾æˆ¦æ¸ˆã¿' : '';
            }
            
            // å¤‰æ›´ã•ã‚ŒãŸã‚»ãƒ«ã‚’è¨˜éŒ²
            const changedCells = [
                `cell-${type1}-${matchId1}-${pos1}`,
                `cell-${type2}-${matchId2}-${pos2}`,
            ];
            
            // å†æç”»
            renderSchedule();
            
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
            highlightCells(changedCells);
            
            cancelSwap();
        }
        
        // =============================================================================
        // å¯¾æˆ¦ç›¸æ‰‹å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè‡ªåˆ†ãŒç§»å‹•ã™ã‚‹ï¼‰
        // =============================================================================
        let changeModalContext = null;  // {matchId, position, currentTeam}
        
        function openChangeModal(matchId, position) {
            // é¸æŠä¸­ã®å…¥ã‚Œæ›¿ãˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            cancelSwap();
            
            const match = schedule.training.find(m => m.id === matchId);
            if (!match) return;
            
            const currentTeam = match[position];
            
            changeModalContext = { matchId, position, currentTeam };
            
            document.getElementById('changeModalSubtitle').textContent = 
                `${currentTeam.name} ã‚’åˆ¥ã®è©¦åˆã«ç§»å‹•`;
            
            // ç§»å‹•å…ˆã®å€™è£œï¼ˆåŒé †ä½ã®ä»–ãƒãƒ¼ãƒ ã¨ã®è©¦åˆï¼‰
            const candidates = [];
            schedule.training.forEach(m => {
                if (m.id === matchId) return;
                
                // ãƒ›ãƒ¼ãƒ å´ãŒåŒé †ä½ãªã‚‰ã€ãã“ã«å…¥ã‚Œã‚‹å€™è£œ
                if (m.home.rank === currentTeam.rank && m.home.id !== currentTeam.id) {
                    const wouldPlay = m.away;
                    candidates.push({
                        match: m,
                        position: 'home',
                        swapWith: m.home,
                        opponent: wouldPlay,
                        venue: m.venue,
                    });
                }
                // ã‚¢ã‚¦ã‚§ã‚¤å´ãŒåŒé †ä½ãªã‚‰
                if (m.away.rank === currentTeam.rank && m.away.id !== currentTeam.id) {
                    const wouldPlay = m.home;
                    candidates.push({
                        match: m,
                        position: 'away',
                        swapWith: m.away,
                        opponent: wouldPlay,
                        venue: m.venue,
                    });
                }
            });
            
            // é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const list = document.getElementById('opponentList');
            list.innerHTML = candidates.map((c, idx) => {
                const isPlayedWith = isPlayed(currentTeam.id, c.opponent.id);
                const isRecommended = !isPlayedWith;
                
                let className = 'opponent-item';
                let badge = '';
                
                if (isPlayedWith) {
                    badge = '<span class="badge badge-played">å¯¾æˆ¦æ¸ˆã¿</span>';
                } else if (isRecommended) {
                    className += ' recommended';
                    badge = '<span class="badge badge-recommended">â˜…ãŠã™ã™ã‚</span>';
                }
                
                // ä¼šå ´åã‚’çŸ­ç¸®è¡¨ç¤º
                const venueShort = c.venue.replace('é«˜G', '').replace('é«˜', '');
                
                return `
                    <li class="${className}" onclick="selectDestination(${idx})">
                        <div>
                            <div>â†’ ${c.opponent.name} ã¨å¯¾æˆ¦</div>
                            <div style="font-size:11px;color:#666;">ï¼ˆ${c.swapWith.name} ã¨å…¥ã‚Œæ›¿ãˆ / ${venueShort}ï¼‰</div>
                        </div>
                        ${badge}
                    </li>
                `;
            }).join('');
            
            // å€™è£œã‚’ä¿å­˜
            changeModalContext.candidates = candidates;
            
            document.getElementById('changeModal').classList.add('active');
        }
        
        function closeChangeModal() {
            document.getElementById('changeModal').classList.remove('active');
            changeModalContext = null;
        }
        
        function selectDestination(candidateIdx) {
            if (!changeModalContext || !changeModalContext.candidates) return;
            
            const { matchId, position, currentTeam, candidates } = changeModalContext;
            const candidate = candidates[candidateIdx];
            if (!candidate) return;
            
            const sourceMatch = schedule.training.find(m => m.id === matchId);
            const destMatch = candidate.match;
            
            if (!sourceMatch || !destMatch) return;
            
            // å…¥ã‚Œæ›¿ãˆå®Ÿè¡Œ
            sourceMatch[position] = candidate.swapWith;
            destMatch[candidate.position] = currentTeam;
            
            // è­¦å‘Šå†è¨ˆç®—
            sourceMatch.warning = isPlayed(sourceMatch.home.id, sourceMatch.away.id) ? 'âš ï¸ å¯¾æˆ¦æ¸ˆã¿' : '';
            destMatch.warning = isPlayed(destMatch.home.id, destMatch.away.id) ? 'âš ï¸ å¯¾æˆ¦æ¸ˆã¿' : '';
            
            // å¤‰æ›´ã•ã‚ŒãŸã‚»ãƒ«ã‚’è¨˜éŒ²
            const changedCells = [
                `cell-training-${matchId}-${position}`,
                `cell-training-${destMatch.id}-${candidate.position}`,
            ];
            
            renderSchedule();
            
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
            highlightCells(changedCells);
            
            closeChangeModal();
        }
        
        // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½
        function highlightCells(cellIds) {
            cellIds.forEach(id => {
                const cell = document.getElementById(id);
                if (cell) {
                    cell.classList.add('highlight-changed');
                }
            });
            
            // 3ç§’å¾Œã«è§£é™¤
            setTimeout(() => {
                cellIds.forEach(id => {
                    const cell = document.getElementById(id);
                    if (cell) {
                        cell.classList.remove('highlight-changed');
                    }
                });
            }, 3000);
        }
        
        function findTeamById(id) {
            for (const group of Object.values(standings)) {
                const team = group.find(t => t.id === id);
                if (team) return team;
            }
            return null;
        }
        
        // =============================================================================
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        // =============================================================================
        function exportSchedule() {
            const data = {
                date: '2025å¹´3æœˆ31æ—¥ï¼ˆæœˆï¼‰',
                tournament: schedule.tournament.map(m => ({
                    id: m.id,
                    type: m.type,
                    venue: m.venue,
                    kickoff: m.kickoff,
                    home: m.home ? { id: m.home.id, name: m.home.name, seed: `${m.home.group}1` } : null,
                    away: m.away ? { id: m.away.id, name: m.away.name, seed: `${m.away.group}1` } : null,
                    homeSeed: m.homeSeed || null,
                    awaySeed: m.awaySeed || null,
                })),
                training: schedule.training.map(m => ({
                    id: m.id,
                    venue: m.venue,
                    kickoff: m.kickoff,
                    home: { id: m.home.id, name: m.home.name, seed: `${m.home.group}${m.home.rank}` },
                    away: { id: m.away.id, name: m.away.name, seed: `${m.away.group}${m.away.rank}` },
                    warning: m.warning,
                })),
                standings: Object.entries(standings).map(([group, teams]) => ({
                    group,
                    teams: teams.map(t => ({
                        id: t.id,
                        name: t.name,
                        rank: t.rank,
                        points: t.points,
                        goalDiff: t.goalDiff,
                        goalsFor: t.goalsFor,
                    })),
                })),
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'final_day_schedule.json';
            a.click();
            
            alert('çµ„ã¿åˆã‚ã›ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\n\nPDFç”Ÿæˆã¯Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¡Œã„ã¾ã™ã€‚');
        }
    </script>
</body>
</html>
