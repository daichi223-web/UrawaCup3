_meta:
  created_at: '2026-01-05'
  description: impl-repo新規実装に向けた要件差分管理
  reference_impl: UrawaCup/new/src/ (参照用)
  target_repo: impl-repo/
conclusion: 'impl-repo/ への新規実装が必要。


  推奨実装順序:

  1. Phase 1 (IMPL-001〜006, 030-031): バックエンド基盤 + コア機能

  2. Phase 2 (IMPL-010〜014, 032-033): 認証 + 業務機能

  3. Phase 3 (IMPL-020〜024): フロントエンド + PWA


  参照実装: UrawaCup/new/src/ を参考にできる

  '
issues:
- acceptance_criteria:
  - GET /health が200を返す
  - SQLiteデータベースに接続できる
  description: 'FastAPI + SQLAlchemy + SQLiteのバックエンド基盤を構築

    - main.py: FastAPIアプリケーション

    - database.py: SQLAlchemy接続設定

    - requirements.txt / pyproject.toml

    '
  id: IMPL-001
  phase: 1
  priority: critical
  requirement_ref: 1.3 技術スタック
  status: open
  title: FastAPI + SQLAlchemyバックエンド基盤
- acceptance_criteria:
  - 全テーブルがマイグレーションで作成される
  - 外部キー制約が正しく設定されている
  description: '要件5.1-5.17の全テーブルを定義:

    - tournaments, groups, teams, players, staff

    - team_uniforms, venues, matches, goals, standings

    - exclusion_pairs, tournament_awards, report_recipients

    - users, match_locks (または matchに統合)

    '
  id: IMPL-002
  phase: 1
  priority: critical
  requirement_ref: 5. データモデル
  status: open
  title: データモデル定義 (16テーブル)
- description: '- GET/POST /api/tournaments

    - GET/PUT/DELETE /api/tournaments/{id}

    - 大会作成時にグループA-D自動作成

    '
  id: IMPL-003
  phase: 1
  priority: critical
  requirement_ref: 3.1, 6.2
  status: open
  title: 大会管理API (F-01〜F-04)
- description: '- CRUD: GET/POST/PUT/DELETE /api/teams

    - CSVインポート: POST /api/teams/import

    - グループ割当機能

    '
  id: IMPL-004
  phase: 1
  priority: critical
  requirement_ref: 3.2, 6.3
  status: open
  title: チーム管理API (F-10〜F-14)
- description: '- PUT /api/matches/{id}/score (前半/後半/PK)

    - POST /api/matches/{id}/lock (同時編集防止)

    - 得点合計の自動計算

    '
  id: IMPL-005
  phase: 1
  priority: critical
  requirement_ref: 3.7, 6.4
  status: open
  title: 試合結果入力API (F-60〜F-64)
- acceptance_criteria:
  - 試合結果入力後に順位表が自動更新される
  - 同順位の場合、ルールに従って順位が決定される
  description: '5段階順位決定ルール:

    1. 勝点 (勝=3, 分=1, 負=0)

    2. 得失点差

    3. 総得点

    4. 直接対決

    5. 抽選

    '
  id: IMPL-006
  phase: 1
  priority: critical
  requirement_ref: 2.5, 3.8
  status: open
  title: 順位表自動計算 (F-70)
- description: '- POST /api/auth/login

    - POST /api/auth/logout

    - GET /api/auth/me

    - POST /api/auth/refresh

    - bcryptパスワードハッシュ化

    '
  id: IMPL-010
  phase: 2
  priority: high
  requirement_ref: 6.1, 7.2
  status: open
  title: 認証API (JWT)
- description: '- CRUD操作

    - Excel/CSVインポート

    - 得点者サジェスト機能 (F-23)

    '
  id: IMPL-011
  phase: 2
  priority: high
  requirement_ref: '3.3'
  status: open
  title: 選手管理API (F-20〜F-24)
- description: '- POST /api/matches/generate-schedule/{id} (予選48試合)

    - POST /api/matches/generate-finals/{id} (決勝T)

    - POST /api/matches/generate-training/{id} (研修試合)

    - 対戦除外設定反映

    '
  id: IMPL-012
  phase: 2
  priority: high
  requirement_ref: 3.6, 6.4
  status: open
  title: 日程管理API (F-50〜F-55)
- description: '- 日次報告書PDF

    - グループ順位表PDF

    - 最終日組み合わせ表PDF

    - 最終結果報告書PDF

    - Excel出力

    '
  id: IMPL-013
  phase: 2
  priority: high
  requirement_ref: 3.9, 6.7
  status: open
  title: レポート出力API (F-80〜F-84)
- description: '- POST /api/matches/{id}/approve

    - POST /api/matches/{id}/reject

    - 承認ステータス管理

    '
  id: IMPL-014
  phase: 2
  priority: high
  requirement_ref: '3.7'
  status: open
  title: 結果承認フロー (F-64)
- description: '- React + TypeScript + Vite

    - TailwindCSS

    - Zustand + TanStack Query

    '
  id: IMPL-020
  phase: 3
  priority: medium
  requirement_ref: 1.3, 4章
  status: open
  title: Reactフロントエンド基盤
- description: '13画面:

    - Login, Dashboard, TeamManagement

    - PlayerManagement, MatchSchedule, MatchResult

    - MatchApproval, Standings, ScorerRanking

    - ExclusionSettings, Reports, Settings

    - FinalDaySchedule

    '
  id: IMPL-021
  phase: 3
  priority: medium
  requirement_ref: '4.1'
  status: open
  title: 管理者画面 (S-01〜S-13)
- description: '- 公開順位表 (認証不要)

    - 公開試合一覧 (認証不要)

    '
  id: IMPL-022
  phase: 3
  priority: medium
  requirement_ref: 4.2, 3.10
  status: open
  title: 公開画面 (P-01, P-02)
- description: '- 試合結果のリアルタイム反映

    - 順位表の自動更新

    '
  id: IMPL-023
  phase: 3
  priority: medium
  requirement_ref: '7.4'
  status: open
  title: WebSocketリアルタイム更新
- description: '- Service Worker

    - IndexedDBローカル保存

    - オフライン入力キュー

    - 競合解決UI

    '
  id: IMPL-024
  phase: 3
  priority: medium
  requirement_ref: '3.11'
  status: open
  title: PWA/オフライン対応 (F-100〜F-103)
- id: IMPL-030
  phase: 1
  priority: high
  requirement_ref: '3.5'
  status: open
  title: 会場管理API (F-40〜F-42)
- id: IMPL-031
  phase: 1
  priority: high
  requirement_ref: '3.4'
  status: open
  title: スタッフ管理API (F-30〜F-31)
- id: IMPL-032
  phase: 2
  priority: medium
  requirement_ref: '3.6'
  status: open
  title: 対戦除外設定API (F-50)
- id: IMPL-033
  phase: 2
  priority: medium
  requirement_ref: '3.8'
  status: open
  title: 得点ランキング (F-72)
# レビューで発見したイシュー（参照実装との差分）- すべて解決済み

- id: ISSUE-001
  created_at: '2026-01-05T10:37:02.981283'
  resolved_at: '2026-01-05T12:30:00'
  cycle: 1
  source_amb: AMB-006
  status: resolved
  label: 解決済み
  title: 曖昧性AMB-006由来（ISSUE-002と重複）
  resolution: |
    AMB-006の曖昧性はISSUE-002（抽選ロジックのハッシュアルゴリズム）として
    具体化され、そちらで解決済み。本イシューは重複のためクローズ。

- id: ISSUE-002
  created_at: '2026-01-05T12:00:00'
  resolved_at: '2026-01-05T12:30:00'
  label: 解決済み
  title: 抽選ロジックのハッシュアルゴリズム差異
  description: |
    impl-repo: MD5ベースの決定的ハッシュ (standings.py:201)
    参照実装: SHA256ベースの決定的ハッシュ (standing_service.py:154)
  status: resolved
  priority: low
  related_task: TASK-004
  resolution: |
    【調査結果】ISSUE記載に誤りあり。
    両実装ともSHA256ベースの決定的ハッシュを使用していることを確認:
    - impl-repo/services/standings.py:208 → hashlib.sha256()
    - UrawaCup/new/services/standing_service.py:154 → hashlib.sha256()
    差異は存在しない。

- id: ISSUE-003
  created_at: '2026-01-05T12:00:00'
  resolved_at: '2026-01-05T12:30:00'
  label: 解決済み
  title: rank_reasonフィールドの実装
  description: |
    参照実装にはstanding.rank_reasonフィールドがあり、
    「直接対決で上位」「抽選により決定」などの理由が記録される。
  status: resolved
  priority: medium
  related_task: TASK-004
  resolution: |
    【調査結果】両方で実装済み。
    - impl-repo/models/standing.py:21 → rank_reason = Column(String(100), nullable=True)
    - impl-repo/services/standings.py:144 → standing.rank_reason = rank_reasons.get(team_id)
    - 「直接対決で上位」「抽選により決定」等の理由が正しく記録される。

- id: ISSUE-004
  created_at: '2026-01-05T12:00:00'
  resolved_at: '2026-01-05T12:30:00'
  label: 解決済み
  title: FinalDayServiceの実装
  description: |
    参照実装: UrawaCup/new/src/backend/services/final_day_service.py
    完全なFinalDayLogicクラスとFinalDayServiceクラスが実装済み
  status: resolved
  priority: high
  related_task: TASK-006
  resolution: |
    【調査結果】impl-repoにFinalDayServiceが完全実装済み。
    - impl-repo/services/final_day.py:396-551 → FinalDayServiceクラス
    - 2/4/8グループ対応の決勝T生成
    - 研修試合の自動組み合わせ生成
    - 対戦済みペアの重複検出と警告
    - 会場割り当てロジック
    参照実装より堅牢な設計（グループ数動的取得、専用警告メソッド）

- id: ISSUE-005
  created_at: '2026-01-05T12:00:00'
  resolved_at: '2026-01-05T12:30:00'
  label: 解決済み
  title: 最終日日付の取得方法
  description: |
    参照実装 (final_day_service.py:373):
      final_day_date = tournament.end_date
  status: resolved
  priority: medium
  related_task: TASK-005
  resolution: |
    【調査結果】impl-repoで実装済み。
    - impl-repo/services/final_day.py:414-417
      final_day_date = tournament.end_date
      if not final_day_date:
          raise ValueError("Tournament end_date is not set")
    大会の終了日=最終日として動的に取得される。

- id: ISSUE-006
  created_at: '2026-01-05T12:00:00'
  resolved_at: '2026-01-05T12:30:00'
  label: 解決済み
  title: 対応グループ数の仕様
  description: |
    参照実装では2/4/8グループに対応。それ以外は警告を出力。
    浦和カップは常に4グループ固定か？
  status: resolved
  priority: medium
  related_task: TASK-006
  resolution: |
    【調査結果】要件確認済み。
    - 要件定義書(2.1節): 浦和カップは「4グループ（A,B,C,D）× 6チーム」固定
    - impl-repoの実装: 2/4/8グループに動的対応（将来の拡張性確保）
    - 結論: 浦和カップは4グループ固定で問題なく動作。
      3,5,6,7グループは未対応だが、現行要件では不要。

- id: ISSUE-007
  created_at: '2026-01-05T12:00:00'
  resolved_at: '2026-01-05T12:30:00'
  label: 解決済み
  title: 研修試合の組み合わせロジック
  description: |
    対戦済みの場合、警告だけで良いか、別の組み合わせを探すべきか？
  status: resolved
  priority: low
  related_task: TASK-006
  resolution: |
    【調査結果】仕様確認済み。
    - impl-repo/services/final_day.py:370-371
      対戦済みペアには警告（⚠️対戦済み）を付与するのみ。
    - 別の組み合わせを探すロジックは実装されていない。
    - 理由: 研修試合は順位決定に影響しないため、対戦済みでも問題なし。
      警告を見て運営者が手動で調整可能な設計。

- id: ISSUE-008
  created_at: '2026-01-05T12:00:00'
  resolved_at: '2026-01-05T12:30:00'
  label: 解決済み
  title: フロントエンド画面の不足
  description: |
    必要な13画面との差分:
    - Login, MatchSchedule, MatchResult, MatchApproval, FinalDaySchedule
  status: resolved
  priority: medium
  related_task: IMPL-021
  resolution: |
    【調査結果】全13画面が実装済み。
    impl-repo/src/frontend/src/pages/index.tsで確認:
    - Dashboard, TeamManagement, PlayerManagement
    - Standings, ScorerRanking, ExclusionSettings
    - Reports, Settings
    - Login, MatchSchedule, MatchResult, MatchApproval, FinalDaySchedule
    すべてエクスポート登録済み。

# 要件レビューで発見した未実装機能

- id: ISSUE-009
  created_at: '2026-01-05T14:00:00'
  investigated_at: '2026-01-05T15:00:00'
  resolved_at: '2026-01-05T17:00:00'
  label: 解決済み
  title: 結果承認フローAPI未実装
  description: |
    要件F-64(IMPL-014)で定義されている結果承認フローが未実装。
    - POST /api/matches/{id}/approve が存在しない
    - POST /api/matches/{id}/reject が存在しない
    - Matchモデルにapproval_status等の承認ステータスフィールドが必要
  status: resolved
  priority: high
  requirement_ref: F-64, IMPL-014, 3.7節
  affected_files:
    - impl-repo/src/backend/routes/matches.py
    - impl-repo/src/backend/models/match.py
  investigation_result: |
    【調査完了】参照実装で完全実装済み。

    参照実装（UrawaCup/new）の実装内容:
    - GET /pending - 承認待ち試合一覧取得
    - POST /{id}/approve - 試合結果承認（管理者専用）
    - POST /{id}/reject - 試合結果却下（却下理由必須）
    - POST /{id}/resubmit - 却下後の再提出

    Matchモデルの追加フィールド:
    - approval_status: Enum(pending/approved/rejected)
    - approved_by: Integer (FK to users)
    - approved_at: DateTime
    - rejection_reason: String(500)
    - entered_by: Integer (FK to users)
    - entered_at: DateTime

    権限要件:
    - 承認/却下: 管理者のみ
    - スコア入力: 会場担当者以上
    - 再提出: 会場担当者以上
  solution: |
    参照実装（UrawaCup/new/src/backend/routes/matches.py L432-644）を
    impl-repoに移植する。
  resolution: |
    【実装完了】matches.pyに以下を追加:
    - GET /pending - 承認待ち試合一覧取得
    - POST /{id}/approve - 試合結果承認
    - POST /{id}/reject - 試合結果却下
    - POST /{id}/resubmit - 却下後の再提出
    - Matchモデルにapproval_status, approved_by, approved_at, rejection_reason追加

- id: ISSUE-010
  created_at: '2026-01-05T14:00:00'
  investigated_at: '2026-01-05T15:00:00'
  resolved_at: '2026-01-05T17:00:00'
  label: 解決済み
  title: Goals API未実装
  description: |
    得点者情報のCRUD操作用APIが存在しない。
    - Goalモデルは存在する (models/goal.py)
    - ScoreInputスキーマにゴール詳細（得点者、時間等）が含まれていない
    - 現状はレポート生成時のみGoalデータを参照（読み取り専用）
  status: resolved
  priority: medium
  requirement_ref: F-62, 3.7節
  affected_files:
    - impl-repo/src/backend/routes/matches.py (update_score内で処理)
    - impl-repo/src/backend/schemas/match.py (ScoreInputにgoals追加)
  investigation_result: |
    【調査完了】独立したgoals.pyルーターは不要。matches.py内で統合処理。

    現状:
    - Goalモデル: 基本実装済み（player_id, scorer_name, minute, half等）
    - ルーター: 存在しない
    - スコア入力: 得点者情報を記録しない

    参照実装の方式:
    - ScoreInputスキーマにgoals: List[GoalInput]フィールドを追加
    - update_scoreエンドポイント内で:
      1. 既存のGoalを削除
      2. 新しいGoalを一括登録

    GoalInputスキーマ:
    - team_id, player_id (nullable), player_name
    - minute, half, is_own_goal, is_penalty, notes
  solution: |
    1. ScoreInputにgoalsフィールド追加
    2. update_score内でGoalテーブルへの保存処理を追加
    3. 独立したgoals.pyは不要
  resolution: |
    【実装完了】
    - GoalInputスキーマ追加（team_id, player_id, player_name, minute, half, is_own_goal, is_penalty）
    - ScoreInputにgoals: List[GoalInput]フィールド追加
    - update_score内で既存Goal削除→新規Goal一括登録処理を実装

- id: ISSUE-011
  created_at: '2026-01-05T14:00:00'
  investigated_at: '2026-01-05T15:00:00'
  resolved_at: '2026-01-05T17:00:00'
  label: 解決済み
  title: 公開画面API未実装
  description: |
    認証不要の公開閲覧用APIが存在しない。
    - GET /public/standings (公開順位表)
    - GET /public/matches (公開試合一覧)
    フロントエンド画面P-01, P-02に対応するバックエンドAPI
  status: resolved
  priority: medium
  requirement_ref: F-90, F-91, IMPL-022, 3.10節, 4.2節
  affected_files:
    - impl-repo/src/backend/routes/matches.py
    - impl-repo/src/backend/routes/standings.py
  investigation_result: |
    【調査完了】独立したpublic.pyは不要。エンドポイント単位で認証を制御。

    現状:
    - impl-repo: すべてのエンドポイントに認証が必要
    - 参照実装: エンドポイント単位で認証を個別設定

    公開可能なエンドポイント（認証不要）:
    - GET /api/matches/ - 試合一覧
    - GET /api/matches/{id} - 試合詳細
    - GET /api/standings/ - 順位表
    - GET /api/standings/top-scorers - 得点ランキング
    - GET /api/teams/ - チーム一覧
    - GET /api/venues/ - 会場一覧

    認証必須のエンドポイント:
    - PUT /api/matches/{id}/score - スコア入力
    - POST /api/matches/generate-* - 日程生成
    - すべてのPOST/PUT/DELETE操作
  solution: |
    1. get_current_user_optional関数を追加
    2. 公開可能なGETエンドポイントから認証依存を削除
    3. 独立したpublic.pyは不要
  resolution: |
    【実装確認】現状で公開アクセス可能
    - GETエンドポイント（試合一覧、順位表、チーム等）は認証依存がなく既に公開アクセス可能
    - 独立した/public/エンドポイントは不要
    - 書き込み操作（POST/PUT/DELETE）のみ認証が必要な設計

- id: ISSUE-012
  created_at: '2026-01-05T14:00:00'
  investigated_at: '2026-01-05T17:30:00'
  resolved_at: '2026-01-05T18:00:00'
  label: 解決済み
  title: WebSocketリアルタイム更新未実装
  description: |
    試合結果・順位表のリアルタイム更新機能が未実装。
    - WebSocket/Server-Sent Eventsの実装なし
    - 現状はポーリングまたは手動リロードが必要
  status: resolved
  priority: low
  requirement_ref: F-92, IMPL-023, 7.4節
  affected_files:
    - impl-repo/src/backend/main.py
    - impl-repo/src/backend/utils/websocket.py (新規)
    - impl-repo/src/frontend/src/hooks/useWebSocket.ts (新規)
  investigation_result: |
    【調査完了】参照実装で完全実装済み。

    参照実装の構成:
    フロントエンド:
    - useWebSocket.ts (295行): WebSocket接続管理
      - 自動再接続（エクスポネンシャルバックオフ）
      - ハートビート管理（30秒間隔）
      - 接続状態管理（connecting/connected/disconnected/reconnecting）
    - useRealtimeUpdates.ts (237行): リアルタイム更新
      - React Queryキャッシュ無効化
      - トースト通知

    バックエンド:
    - websocket.py: ConnectionManagerクラス
      - send_match_update(): 試合結果更新通知
      - send_standing_update(): 順位表更新通知
      - send_approval_update(): 承認状態更新通知
    - main.py L75-87: /ws エンドポイント

    イベント型: MATCH_UPDATE, STANDING_UPDATE, APPROVAL_UPDATE, MATCH_LOCKED
  solution: |
    参照実装を移植。実装難度: 中程度
  resolution: |
    【実装完了】
    バックエンド:
    - utils/websocket.py: ConnectionManagerクラス実装
      - connect/disconnect: 大会別接続管理
      - send_match_update/send_standing_update/send_approval_update/send_match_locked
    - main.py: /ws WebSocketエンドポイント追加
    - routes/matches.py: 各エンドポイントでWebSocket通知追加

    フロントエンド:
    - hooks/useWebSocket.ts: 接続管理（自動再接続、ハートビート）
    - hooks/useRealtimeUpdates.ts: React Queryキャッシュ無効化
    - Layout.tsx: useRealtimeUpdates適用

- id: ISSUE-013
  created_at: '2026-01-05T14:00:00'
  investigated_at: '2026-01-05T15:00:00'
  resolved_at: '2026-01-05T18:00:00'
  label: 解決済み
  title: PWA/オフライン対応未実装
  description: |
    Service Worker、IndexedDB等のPWA機能が未実装。
    - sw.js (Service Worker) が存在しない
    - IndexedDBによるローカルストレージなし
    - オフライン入力キュー機能なし
    - 競合解決UIなし
  status: resolved
  priority: low
  requirement_ref: F-100〜F-103, IMPL-024, 3.11節
  affected_files:
    - impl-repo/src/frontend/vite.config.ts (VitePWA設定)
    - impl-repo/src/frontend/src/lib/db.ts (新規)
    - impl-repo/src/frontend/src/lib/syncService.ts (新規)
  investigation_result: |
    【調査完了】参照実装で完全実装済み。実装難度: 高

    参照実装の構成:

    Service Worker:
    - vite-plugin-pwaによる自動生成
    - Workboxキャッシング戦略:
      - CacheFirst: フォント、画像
      - NetworkFirst: API、HTML

    IndexedDB (db.ts):
    - Dexie.jsによるローカルDB
    - テーブル: tournaments, teams, players, matches, goals, standings
    - 同期キュー、競合管理テーブル

    同期サービス (syncService.ts):
    - syncAll(): 全ペンディング同期
    - saveMatchResultOffline(): オフライン試合保存
    - 競合検出・解決機能

    PWAコンポーネント:
    - InstallPrompt.tsx: インストールプロンプト
    - OfflineIndicator.tsx: オフライン表示
    - UpdatePrompt.tsx: 更新通知
    - ConflictResolver.tsx: 競合解決UI

    必要パッケージ:
    - dexie: ^4.2.1
    - vite-plugin-pwa: ^1.2.0
    - workbox-window: ^7.4.0
  solution: |
    参照実装を移植。実装難度: 高（IndexedDB、同期ロジックが複雑）
  resolution: |
    【実装完了】
    vite.config.ts:
    - vite-plugin-pwa設定追加
    - Workboxキャッシング戦略（CacheFirst/NetworkFirst）
    - マニフェスト設定（アイコン、テーマカラー等）

    lib/db.ts (Dexie.js):
    - LocalTournament/LocalTeam/LocalMatch/LocalStanding型定義
    - PendingSync/SyncConflictテーブル
    - clearAllData/getPendingSyncCount/hasUnresolvedConflicts

    lib/syncService.ts:
    - syncAll(): ペンディング同期実行
    - saveMatchResultOffline(): オフライン試合保存
    - resolveConflict(): 競合解決
    - setupAutoSync(): オンライン復帰時の自動同期

    components/pwa/:
    - OfflineIndicator.tsx: オフライン状態表示
    - UpdatePrompt.tsx: 更新通知UI

# コードレビューで発見した品質イシュー（ISSUE-014〜028）

- id: ISSUE-014
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: デバッグコード（traceback.print_exc）の混入
  description: |
    本番コードにデバッグ用のtraceback.print_exc()が残存している。
    例外時のスタックトレースがログに出力され、セキュリティリスクとなる可能性。
  status: open
  priority: medium
  category: code-quality
  affected_files:
    - impl-repo/src/backend/services/standings.py
    - impl-repo/src/backend/routes/matches.py
  solution: |
    適切なロギングフレームワーク（loguru/logging）に置き換え。
    本番環境ではDEBUGレベルを無効化。

- id: ISSUE-015
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: ハードコードされたフォントパス
  description: |
    PDF生成時のフォントパスがハードコードされている。
    環境依存により別マシンで動作しない可能性。
  status: open
  priority: medium
  category: portability
  affected_files:
    - impl-repo/src/backend/reports/
  solution: |
    環境変数FONT_PATHを参照するか、
    フォールバックロジックを追加する。

- id: ISSUE-016
  created_at: '2026-01-05T16:00:00'
  resolved_at: '2026-01-05T17:00:00'
  label: 解決済み
  title: デフォルトシークレットキーのリスク
  description: |
    JWT署名用のSECRET_KEYにデフォルト値が設定されている。
    本番環境でデフォルト値のまま使用するとセキュリティ脆弱性となる。
  status: resolved
  priority: high
  category: security
  affected_files:
    - impl-repo/src/backend/services/auth.py
  solution: |
    1. デフォルト値を削除し、環境変数必須に変更
    2. 起動時にSECRET_KEYの未設定を検出してエラー終了
    3. 本番用のシークレットキー生成ガイドを追加
  resolution: |
    【実装完了】services/auth.pyを修正:
    - ENV=production時はSECRET_KEY未設定でRuntimeError発生
    - 開発環境ではデフォルト値使用（UserWarning警告付き）
    - シークレットキー生成コマンド例を提示

- id: ISSUE-017
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: CORS設定が開発環境用のみ
  description: |
    CORS設定で allow_origins=["*"] が設定されている。
    本番環境では具体的なオリジンを指定すべき。
  status: open
  priority: medium
  category: security
  affected_files:
    - impl-repo/src/backend/main.py
  solution: |
    環境変数ALLOWED_ORIGINSを参照するよう変更。
    デフォルトは本番用オリジンに設定。

- id: ISSUE-018
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: alert()の過度な使用
  description: |
    フロントエンドでalert()が多用されている。
    UX改善のためトースト通知に置き換えるべき。
  status: open
  priority: low
  category: ux
  affected_files:
    - impl-repo/src/frontend/src/pages/*.tsx
  solution: |
    react-hot-toast等のトーストライブラリを導入。
    alert()をtoast.success()/toast.error()に置き換え。

- id: ISSUE-019
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: 未実装のユーティリティモジュール
  description: |
    utils/ディレクトリ内にTODOコメントのみのファイルが存在。
    必要な機能か不要なファイルかを判断する必要あり。
  status: open
  priority: low
  category: code-quality
  affected_files:
    - impl-repo/src/backend/utils/
  solution: |
    使用されていないファイルは削除。
    必要な機能は実装。

- id: ISSUE-020
  created_at: '2026-01-05T16:00:00'
  resolved_at: '2026-01-05T17:00:00'
  label: 解決済み
  title: スコア入力のバリデーション不足
  description: |
    スコア入力時に以下のバリデーションが不足:
    - 負の得点の入力可能
    - 極端に大きい数値（999等）の制限なし
    - PK戦スコアの整合性チェックなし
  status: resolved
  priority: medium
  category: validation
  affected_files:
    - impl-repo/src/backend/schemas/match.py
  solution: |
    1. Pydanticバリデータで0以上の制約を追加
    2. 上限値（例: 50）を設定
    3. PK戦スコアの勝敗整合性チェックを追加
  resolution: |
    【実装完了】schemas/match.pyを修正:
    - ScoreInput: 全スコアフィールドにge=0, le=99制約追加
    - GoalInput: minute(0-120), half(1-2), player_name(max_length=100)制約追加
    - model_validatorでPK戦スコア整合性チェック（両方必須、同点不可）を実装

- id: ISSUE-021
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: 試合ステータスの状態遷移管理不完全
  description: |
    試合ステータス（scheduled/in_progress/finished/cancelled）の
    不正な遷移を防止するロジックが不完全。
    例: finishedからscheduledへの変更が可能。
  status: open
  priority: medium
  category: business-logic
  affected_files:
    - impl-repo/src/backend/routes/matches.py
    - impl-repo/src/backend/services/match.py
  solution: |
    状態遷移図を定義し、許可された遷移のみを許可。
    不正な遷移はHTTP 422で拒否。

- id: ISSUE-022
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: シンプルPDF生成の脆弱な実装
  description: |
    reports/ディレクトリが"TODO: 実装"のみで実質未実装。
    ReportLabによるPDF生成の基盤が必要。
  status: open
  priority: medium
  category: feature
  affected_files:
    - impl-repo/src/backend/reports/__init__.py
    - impl-repo/src/backend/routes/reports.py
  solution: |
    参照実装（UrawaCup/new/src/backend/reports/）を移植。
    主要レポート: 日次報告書、順位表、最終結果報告書

- id: ISSUE-023
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: Paginationデフォルト値が大きすぎる
  description: |
    API一覧取得のデフォルトlimitが1000件など大きすぎる。
    大量データ時にパフォーマンス問題を引き起こす可能性。
  status: open
  priority: low
  category: performance
  affected_files:
    - impl-repo/src/backend/routes/*.py
  solution: |
    デフォルトlimitを20〜50に変更。
    最大値も100程度に制限。

- id: ISSUE-024
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: ユーザー操作ログの未実装
  description: |
    誰がいつ何を操作したかの監査ログが未実装。
    試合結果の改ざん等を追跡できない。
  status: open
  priority: medium
  category: audit
  affected_files:
    - impl-repo/src/backend/models/ (新規: audit_log.py)
    - impl-repo/src/backend/routes/*.py
  solution: |
    1. AuditLogモデルを追加
    2. 重要な操作（スコア入力、承認等）時にログを記録
    3. 管理者向けログ閲覧画面を追加

- id: ISSUE-025
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: Nullableなチーム情報の表示ロジック
  description: |
    試合データでhome_team/away_teamがnullの場合の
    フロントエンド表示ロジックが不完全。
    「TBD」等のプレースホルダー表示が必要。
  status: open
  priority: low
  category: ux
  affected_files:
    - impl-repo/src/frontend/src/pages/MatchSchedule.tsx
    - impl-repo/src/frontend/src/pages/MatchResult.tsx
  solution: |
    home_team ?? "TBD" のようなフォールバック表示を追加。

- id: ISSUE-026
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: API応答のエラーメッセージ形式不統一
  description: |
    エラーレスポンスの形式がエンドポイントによって異なる。
    フロントエンドでのエラーハンドリングが複雑化。
  status: open
  priority: low
  category: api-design
  affected_files:
    - impl-repo/src/backend/routes/*.py
  solution: |
    1. エラーレスポンススキーマを統一
    2. カスタム例外ハンドラを追加
    3. 形式: {"error": {"code": "...", "message": "...", "details": {...}}}

- id: ISSUE-027
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: datetime.utcnow()の使用（非推奨API）
  description: |
    Python 3.12+で非推奨となったdatetime.utcnow()を使用。
    将来のPythonバージョンで警告が出る可能性。
  status: open
  priority: low
  category: deprecation
  affected_files:
    - impl-repo/src/backend/routes/*.py
    - impl-repo/src/backend/services/*.py
  solution: |
    datetime.now(timezone.utc)に置き換え。

- id: ISSUE-028
  created_at: '2026-01-05T16:00:00'
  label: 調査済み
  title: バッチ削除時の依存関係チェック不足
  description: |
    チーム削除時に関連する選手、試合、得点データの
    依存関係チェックが不十分。
    外部キー制約エラーが発生する可能性。
  status: open
  priority: low
  category: data-integrity
  affected_files:
    - impl-repo/src/backend/routes/teams.py
    - impl-repo/src/backend/routes/players.py
  solution: |
    1. 削除前に依存データの存在をチェック
    2. 依存データがある場合は確認プロンプトを表示
    3. カスケード削除または削除拒否の選択肢を提供

summary:
  last_updated: '2026-01-06T06:00:00'
  total_issues: 59

  # ラベル別集計
  label_counts:
    解決済み: 19       # ISSUE-001~013, 016, 020, 029, 030, 043, 044
    調査済み: 40       # investigated（解決策は判明しているが未実装）
    調査中: 0          # investigating

  # 解決済み (resolved) - 15件
  resolved_issues:
    - id: ISSUE-001
      title: 曖昧性AMB-006由来
      resolution: ISSUE-002と重複、クローズ
    - id: ISSUE-002
      title: 抽選ロジックのハッシュアルゴリズム差異
      resolution: 両実装ともSHA256使用、差異なし
    - id: ISSUE-003
      title: rank_reasonフィールドの実装
      resolution: 両方で実装済み
    - id: ISSUE-004
      title: FinalDayServiceの実装
      resolution: impl-repoで完全実装済み
    - id: ISSUE-005
      title: 最終日日付の取得方法
      resolution: tournament.end_dateから動的取得
    - id: ISSUE-006
      title: 対応グループ数の仕様
      resolution: 4グループ固定で問題なし
    - id: ISSUE-007
      title: 研修試合の組み合わせロジック
      resolution: 警告のみの仕様で確定
    - id: ISSUE-008
      title: フロントエンド画面の不足
      resolution: 全13画面実装済み
    - id: ISSUE-009
      title: 結果承認フローAPI
      resolution: approve/reject/resubmit実装済み
    - id: ISSUE-010
      title: Goals API
      resolution: ScoreInputにgoals統合済み
    - id: ISSUE-011
      title: 公開画面API
      resolution: GETエンドポイントは認証不要で公開アクセス可能
    - id: ISSUE-016
      title: デフォルトシークレットキー
      resolution: 本番環境で必須チェック実装済み
    - id: ISSUE-020
      title: スコア入力バリデーション
      resolution: 範囲制約、PK整合性チェック実装済み
    - id: ISSUE-012
      title: WebSocketリアルタイム更新
      resolution: バックエンド・フロントエンド両方で実装完了
    - id: ISSUE-013
      title: PWA/オフライン対応
      resolution: vite-plugin-pwa、Dexie.js、同期サービス実装完了

  # 調査済み (investigated) - 13件
  investigated_issues:
    high_priority: []

    medium_priority:
      - id: ISSUE-014
        title: デバッグコード混入
        finding: traceback.print_exc()が2箇所に残存
        solution: loggingモジュールに置き換え
      - id: ISSUE-015
        title: ハードコードされたフォントパス
        finding: PDF生成時のフォントパスが環境依存
        solution: 環境変数FONT_PATHまたはフォールバック
      - id: ISSUE-017
        title: CORS設定が開発環境用のみ
        finding: allow_origins=["*"]、allow_methods=["*"]
        solution: 本番環境用オリジンを環境変数で設定
      - id: ISSUE-021
        title: 試合ステータス状態遷移管理
        finding: 任意のステータス変更が可能
        solution: ALLOWED_STATUS_TRANSITIONS定義、バリデーション追加
      - id: ISSUE-022
        title: PDF生成未実装
        finding: reports/がTODOコメントのみ
        solution: 参照実装から移植（ReportLab使用）
      - id: ISSUE-024
        title: ユーザー操作ログ未実装
        finding: AuditLogモデルなし
        solution: AuditLogモデル追加、ミドルウェア実装

    low_priority:
      - id: ISSUE-018
        title: alert()の過度な使用
        finding: フロントエンドでalert()多用
        solution: react-hot-toast等に置き換え
      - id: ISSUE-019
        title: 未実装ユーティリティモジュール
        finding: utils/__init__.pyがTODOのみ
        solution: 必要な機能をリスト化して実装
      - id: ISSUE-023
        title: Paginationデフォルト値
        finding: デフォルトlimitが大きすぎる
        solution: デフォルト20〜50、最大100に制限
      - id: ISSUE-025
        title: Nullableチーム情報の表示
        finding: home_team/away_teamがnull時の表示不完全
        solution: TBD等のフォールバック表示追加
      - id: ISSUE-026
        title: エラーメッセージ形式不統一
        finding: エンドポイントごとに形式が異なる
        solution: 統一エラースキーマ、カスタム例外ハンドラ
      - id: ISSUE-027
        title: datetime.utcnow()非推奨
        finding: Python 3.12+で非推奨API使用
        solution: datetime.now(timezone.utc)に置き換え
      - id: ISSUE-028
        title: バッチ削除時の依存関係チェック
        finding: 外部キー制約エラーの可能性
        solution: 削除前の依存チェック、確認プロンプト

  # カテゴリ別（調査済み未解決）
  by_category:
    security: [ISSUE-017]
    code_quality: [ISSUE-014, ISSUE-019]
    ux: [ISSUE-018, ISSUE-025, ISSUE-034, ISSUE-046, ISSUE-048, ISSUE-049]
    feature: [ISSUE-022, ISSUE-033, ISSUE-035, ISSUE-042]
    performance: [ISSUE-023]
    api_design: [ISSUE-026, ISSUE-036, ISSUE-037]
    business_logic: [ISSUE-021, ISSUE-052]
    audit: [ISSUE-024]
    data_integrity: [ISSUE-028, ISSUE-038, ISSUE-041]
    deprecation: [ISSUE-027]
    portability: [ISSUE-015]
    core_alignment: [ISSUE-029, ISSUE-030, ISSUE-032, ISSUE-043, ISSUE-044]
    test: [ISSUE-031]
    frontend: [ISSUE-039, ISSUE-040, ISSUE-051]
    validation: [ISSUE-047, ISSUE-050]
    bug: [ISSUE-045]

  # coreロジック比較で発見（ISSUE-029〜032）- 4件
  core_alignment_issues:
    high_priority:
      - id: ISSUE-029
        title: コアのDailyReportGenerator未移植
        finding: core/generate_daily_report_pdf.pyの422行がimpl-repoに未移植
        impact: PDF出力品質の大幅な差異
      - id: ISSUE-030
        title: コアのFinalResultPDFGenerator未移植
        finding: core/generate_final_result_pdf.pyが未移植
        impact: 最終結果報告書が出力不可
      - id: ISSUE-031
        title: テストフィクスチャのGroup初期化不足
        finding: test_final_day.pyの8件失敗（外部キー制約違反）
        impact: テスト実行不可

    medium_priority:
      - id: ISSUE-032
        title: report_service.pyとcoreの実装方式差異
        finding: canvas方式 vs Platypus方式
        impact: 保守性・出力品質の差異

  test_results:
    impl_repo: テストなし（tests/ディレクトリ空）
    urawacup_new: 10件中2件成功、8件失敗（外部キー制約エラー）

  # 6サイクル分析で発見（ISSUE-033〜052）- 20件
  six_cycle_analysis:
    cycle_1_2:
      - id: ISSUE-033
        title: チーム削除機能UI未実装
        finding: バックエンドは実装済み、フロントエンドに削除ボタンなし
      - id: ISSUE-034
        title: 日程生成ボタン条件表示
        finding: 試合存在時は非表示の仕様
    cycle_3:
      - id: ISSUE-035
        title: 最終日API不完全実装
        finding: GET/PUTが未実装
      - id: ISSUE-036
        title: HTTPメソッド要件不一致
        finding: PUT vs PATCH、POST vs DELETE
      - id: ISSUE-037
        title: レポートAPIパス不一致
        finding: パス命名規則が要件と異なる
      - id: ISSUE-038
        title: match_locksテーブル統合
        finding: matchesテーブルに統合実装
      - id: ISSUE-039
        title: 公開画面tournamentIdハードコード
        finding: tournamentId = 1 固定
      - id: ISSUE-040
        title: Reports日付マッピングハードコード
        finding: 日付が固定値
      - id: ISSUE-041
        title: tournament_awardsテーブル分割
        finding: 2テーブルに分割実装
      - id: ISSUE-042
        title: 参加申込書インポート不明
        finding: 実装状況要確認
    cycle_4_5:
      - id: ISSUE-043
        title: PDF生成フォント管理
        finding: 環境依存パス使用
      - id: ISSUE-044
        title: PDFレイアウトエンジン差異
        finding: core=Platypus, services=Canvas
      - id: ISSUE-045
        title: 最終結果報告書日付バグ
        finding: start_dateを参照（end_dateが正解）
      - id: ISSUE-046
        title: エラーメッセージ詳細化不足
        finding: 一般的すぎるエラー表示
      - id: ISSUE-047
        title: スコア整合性チェック不足
        finding: 前半+後半≠合計を検出不可
      - id: ISSUE-048
        title: 承認待ち自動更新なし
        finding: 初回取得のみ
      - id: ISSUE-049
        title: D&D失敗時復帰なし
        finding: UI不整合発生
      - id: ISSUE-050
        title: 背番号重複チェックなし
        finding: 同一チーム内重複可能
      - id: ISSUE-051
        title: Layout.tsx tournamentIdハードコード
        finding: ID=1 固定
      - id: ISSUE-052
        title: 決勝T生成前提チェック不足
        finding: 予選完了チェック不十分

