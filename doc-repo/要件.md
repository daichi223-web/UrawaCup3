# 浦和カップ トーナメント管理システム 要件定義

## 概要

浦和カップ高校サッカーフェスティバルの運営を効率化するためのWebアプリケーション。

詳細仕様: `../urawacup_requirements.md` を参照

## 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | React + TypeScript + Vite |
| スタイリング | TailwindCSS 3.x |
| 状態管理 | Zustand + TanStack Query |
| バックエンド | FastAPI + SQLAlchemy |
| データベース | SQLite |
| PDF生成 | ReportLab |
| テスト | pytest + Playwright |

## 実装タスク

### Phase 1: バックエンド基盤

| ID | タスク | 説明 |
|----|--------|------|
| BE-001 | プロジェクト構造 | FastAPI + SQLAlchemy プロジェクト構造作成 |
| BE-002 | データモデル | 全14テーブルのSQLAlchemyモデル定義 |
| BE-003 | 認証API | JWT認証 (login, logout, me, refresh) |
| BE-004 | 大会API | 大会CRUD + グループ自動作成 |
| BE-005 | チームAPI | チームCRUD + CSVインポート |
| BE-006 | 選手API | 選手CRUD + Excel/CSVインポート |
| BE-007 | 試合API | 試合CRUD + スコア入力 + ロック機能 |
| BE-008 | 日程生成 | 予選日程/決勝T/研修試合の自動生成 |
| BE-009 | 順位計算 | 5段階順位決定ロジック |
| BE-010 | レポートAPI | PDF/Excel出力 |

### Phase 2: フロントエンド

| ID | タスク | 説明 |
|----|--------|------|
| FE-001 | プロジェクト構造 | Vite + React + TypeScript + TailwindCSS |
| FE-002 | 状態管理 | Zustand appStore + TanStack Query |
| FE-003 | 認証画面 | ログイン/ログアウト |
| FE-004 | ダッシュボード | 統計サマリー |
| FE-005 | チーム管理 | チーム一覧/編集/CSVインポート |
| FE-006 | 選手管理 | 選手一覧/編集/Excelインポート |
| FE-007 | 日程管理 | 日程表示/編集 |
| FE-008 | 結果入力 | スコア入力/得点者入力 |
| FE-009 | 順位表 | グループ別順位表 |
| FE-010 | レポート出力 | PDF/Excel出力画面 |
| FE-011 | 公開画面 | 認証不要の順位表/試合一覧 |

## データモデル概要

| テーブル | 説明 |
|---------|------|
| tournaments | 大会情報 |
| groups | グループ（A〜D） |
| teams | チーム（24件/大会） |
| players | 選手（600-1200件/大会） |
| staff | スタッフ |
| team_uniforms | ユニフォーム |
| venues | 会場（4-5件/大会） |
| matches | 試合（72件/大会） |
| goals | 得点 |
| standings | 順位表 |
| exclusion_pairs | 対戦除外ペア |
| tournament_awards | 表彰情報 |
| report_recipients | 報告書送信先 |
| users | ユーザー |

## 順位決定ルール

1. 勝点（勝利=3点、引分=1点、敗北=0点）
2. 得失点差
3. 総得点
4. 当該チーム間の対戦成績
5. 抽選（決定的ハッシュベース）

---

## 調査結果（2026年1月5日実施）

### PM調査結果

#### プロジェクト進捗状況

| フェーズ | 完了率 | 内容 |
|---------|-------|------|
| Phase 1: MINI | 100% | チーム・グループ管理、試合結果入力、順位表自動計算、基礎エクスポート |
| Phase 2: MIDDLE | 100% | 公式帳票出力、分散入力対応、結果承認フロー、日程調整アシスト、決勝Tマッチング |
| Phase 3: MAX | 95% | パブリックビューイング、詳細スタッツ、オフライン対応（PWA） - UI改善が残項目 |

#### 実装リポジトリ状況

| リポジトリ | パス | 状況 |
|-----------|------|------|
| impl-repo | `D:\UrawaCup2\impl-repo\` | 新規実装中（スケルトン状態） |
| UrawaCup/new | `D:\UrawaCup2\UrawaCup\new\` | 参照実装（フル機能実装済み） |

#### タスク状況

| タスクID | タイトル | ステータス |
|---------|---------|-----------|
| TASK-001 | Hello World関数の実装 | approved |
| TASK-002 | 計算ユーティリティの実装 | approved |
| TASK-003 | トーナメントID取得のコンテキスト化 | implemented |
| TASK-004 | 同順位時の抽選ロジック実装 | implemented |
| TASK-005 | 最終日日付の動的算出 | implemented |
| TASK-006 | 複数グループ対応の決勝T生成 | implemented |

#### 推奨アクション（優先順位順）

1. **【高】ISSUE-004**: FinalDayServiceのimpl-repoへの移植
2. **【高】IMPL-013**: レポート出力APIの実装
3. **【中】ISSUE-008**: 不足フロントエンド画面の実装（Login, MatchSchedule, MatchResult, MatchApproval, FinalDaySchedule）
4. **【中】ISSUE-002/003**: impl-repoの抽選ロジックをSHA256に統一、rank_reason追加
5. **【低】ISSUE-006**: 3,5,6,7グループ対応（将来的な拡張性）

---

### テスト調査結果

#### バックエンドテスト

**ファイル場所:** `D:\UrawaCup2\UrawaCup\new\src\backend\tests\`

| ファイル名 | 内容 |
|-----------|------|
| conftest.py | pytest共通設定・フィクスチャ定義 |
| test_health.py | ヘルスチェックエンドポイントテスト（2テスト） |
| test_final_day.py | 最終日組み合わせ機能テスト（8テスト） |

**テスト実行結果:**
- 成功: 2件（test_health_check, test_root_endpoint）
- 失敗: 8件（外部キー制約違反 - グループテーブル初期化未実装）

#### フロントエンドテスト

**E2Eテスト（Playwright）:**

| ファイル名 | テスト数 | 内容 |
|-----------|---------|------|
| auth.spec.ts | 4テスト | ログイン・ログアウト・認証エラー処理 |
| teams.spec.ts | 4テスト | チーム管理機能 |
| matches.spec.ts | 10テスト | 試合管理、順位表、得点ランキング |
| interactions.spec.ts | 27テスト | 全ボタン・入力・編集機能 |
| comprehensive-ui.spec.ts | 39テスト | 全ページUI要素チェック |

**E2Eテスト合計:** 84テスト

#### テスト問題点

| カテゴリ | 問題 | 影響度 |
|---------|------|--------|
| バックエンド | test_final_day.pyの外部キー制約違反 | 高 |
| バックエンド | グループテーブル初期化がフィクスチャに未実装 | 高 |
| フロントエンド | ユニットテストファイルが存在しない | 高 |
| 全体 | テストカバレッジ測定が未設定 | 中 |

---

### コードベース調査結果

#### バックエンド実装状況

| 機能 | 実装率 | 備考 |
|------|------|------|
| モデル定義 | 100% | 16個全て実装 |
| ルーター実装 | 85% | 8つ全て実装、エンドポイント完全 |
| スキーマ定義 | 90% | ほぼ完全 |
| ビジネスロジック | 70% | 順位計算、日程生成は完全。レポート生成未実装 |
| 認証・認可 | 30% | ユーザーモデルのみ。JWTトークン未実装 |
| テスト | 0% | tests/ディレクトリが空 |

#### フロントエンド実装状況

| 機能 | 実装率 | 備考 |
|------|------|------|
| ページコンポーネント | 100% | 8つ全てのページ実装 |
| ルーティング | 100% | React Router v6で設定 |
| 状態管理 | 100% | Zustandでtournamentコンテキスト管理 |
| API通信 | 85% | axios + react-query実装、エラー処理要強化 |
| 認証画面 | 0% | ログインページなし |
| テスト | 0% | 未実装 |

#### 未実装機能

**高優先度:**
1. レポート出力（F-80〜F-84）- reports/ディレクトリが空
2. CSVインポート（F-12, F-21）- UIは完成、バックエンド未実装
3. 得点者入力と得点ランキング計算
4. 結果承認フロー（F-64）

**中〜低優先度:**
5. 公開機能（F-90〜F-92）- 認証不要ページ、WebSocket未実装
6. オフライン・PWA（F-100〜F-103）

---

### ドキュメント調査結果

#### doc-repo内のドキュメント

| ファイル名 | 種別 | 内容 |
|-----------|------|------|
| 要件.md | 要件概要 | 技術スタック、実装タスク一覧 |
| spec.yaml | 技術仕様書 | プロジェクト構造、データモデル定義 |
| issues.yaml | 課題管理 | 19件のIMPL課題 + 8件のイシュー |
| tasks.yaml | タスク管理 | 6件のタスク定義 |
| cycle-log.md | 実装ログ | 実装サイクルの詳細履歴 |

#### 要件と実装の整合性

| カテゴリ | 要件完了率 | 備考 |
|---------|----------|------|
| データモデル | 100% | 16/16テーブル実装済み |
| バックエンドAPI | 80% | レポートAPIが未完成 |
| フロントエンド | 0% | 未着手（impl-repo） |
| PWA/オフライン | 0% | Phase 3スコープ |

#### イシュー状況（全8件解決済み）

| ID | タイトル | 解決内容 |
|----|---------|---------|
| ISSUE-001 | 曖昧性AMB-006由来 | ISSUE-002と重複、クローズ |
| ISSUE-002 | 抽選ロジックのハッシュアルゴリズム差異 | 両実装ともSHA256使用、差異なし |
| ISSUE-003 | rank_reasonフィールドの実装 | 両方で実装済み |
| ISSUE-004 | FinalDayServiceの実装 | impl-repoで完全実装済み |
| ISSUE-005 | 最終日日付の取得方法 | tournament.end_dateから動的取得 |
| ISSUE-006 | 対応グループ数の仕様 | 4グループ固定で問題なし |
| ISSUE-007 | 研修試合の組み合わせロジック | 警告のみの仕様で確定 |
| ISSUE-008 | フロントエンド画面の不足 | 全13画面実装済み |

#### 未実装機能イシュー（ISSUE-009〜013）

| ID | タイトル | 優先度 | 解決策 |
|----|---------|--------|--------|
| ISSUE-009 | 結果承認フローAPI未実装 | 高 | 参照実装から移植 |
| ISSUE-010 | Goals API未実装 | 中 | ScoreInputにgoalsフィールド追加 |
| ISSUE-011 | 公開画面API未実装 | 中 | エンドポイント単位で認証制御 |
| ISSUE-012 | WebSocketリアルタイム更新未実装 | 低 | 参照実装から移植 |
| ISSUE-013 | PWA/オフライン対応未実装 | 低 | 参照実装から移植（難度:高） |

#### コードレビュー指摘（ISSUE-014〜028）

| ID | タイトル | 優先度 | カテゴリ |
|----|---------|--------|----------|
| ISSUE-014 | デバッグコードの混入 | 中 | コード品質 |
| ISSUE-015 | ハードコードされたフォントパス | 中 | 移植性 |
| ISSUE-016 | デフォルトシークレットキーのリスク | **高** | セキュリティ |
| ISSUE-017 | CORS設定が開発環境用のみ | 中 | セキュリティ |
| ISSUE-018 | alert()の過度な使用 | 低 | UX |
| ISSUE-019 | 未実装のユーティリティモジュール | 低 | コード品質 |
| ISSUE-020 | スコア入力のバリデーション不足 | 中 | バリデーション |
| ISSUE-021 | 試合ステータスの状態遷移管理不完全 | 中 | ビジネスロジック |
| ISSUE-022 | PDF生成の未実装 | 中 | 機能 |
| ISSUE-023 | Paginationデフォルト値が大きすぎる | 低 | パフォーマンス |
| ISSUE-024 | ユーザー操作ログの未実装 | 中 | 監査 |
| ISSUE-025 | Nullableなチーム情報の表示ロジック | 低 | UX |
| ISSUE-026 | API応答のエラーメッセージ形式不統一 | 低 | API設計 |
| ISSUE-027 | datetime.utcnow()の使用（非推奨API） | 低 | 非推奨 |
| ISSUE-028 | バッチ削除時の依存関係チェック不足 | 低 | データ整合性 |

---

### coreロジック比較結果（2026年1月5日実施）

**比較対象:**
- coreディレクトリ: `D:\UrawaCup2\core\`
- impl-repo: `D:\UrawaCup2\impl-repo\src\backend\`

#### final_day.py（最終日組み合わせ生成）

| 項目 | 整合性 | 詳細 |
|-----|--------|------|
| FinalDayLogicクラス | ✅ 完全一致 | coreのFinalDayGeneratorと同等 |
| 4グループペアリング | ✅ 完全一致 | A1vsC1, B1vsD1パターン |
| 研修試合ロジック | ✅ 完全一致 | Round1(AvsC,BvsD), Round2(AvsD,BvsC) |
| グループ数対応 | ✅ 拡張済み | 2/4/8グループ対応（coreは4固定） |

**結論:** final_day.pyはcoreロジックを完全に保持し、グループ数動的対応として拡張されている。

#### PDF生成ロジック

| 項目 | 整合性 | 詳細 |
|-----|--------|------|
| DailyReportGenerator | ❌ 未移植 | core/generate_daily_report_pdf.py (422行) |
| FinalResultPDFGenerator | ❌ 未移植 | core/generate_final_result_pdf.py |
| report_service.py | ⚠️ 別系統 | canvas方式（coreはPlatypus方式） |
| reports/__init__.py | ❌ 未実装 | TODOコメントのみ |

**発見された問題:**

| ISSUE ID | タイトル | 優先度 |
|----------|---------|--------|
| ISSUE-029 | コアのDailyReportGenerator未移植 | 高 |
| ISSUE-030 | コアのFinalResultPDFGenerator未移植 | 高 |
| ISSUE-031 | テストフィクスチャのGroup初期化不足 | 高 |
| ISSUE-032 | report_service.pyとcoreの実装方式差異 | 中 |

---

### 総合評価

**完成度: 70%**（Phase 2レベル）

**イシュー状況:**
- 解決済み: 15件 (ISSUE-001〜013, 016, 020)
- 調査済み: 13件 (ISSUE-014〜028のうち未解決分)
- 新規発見: 4件 (ISSUE-029〜032: coreロジック比較)
- 合計: 32件

**強み:**
- 基本的なCRUD操作、複雑な順位計算ロジックは実装完了
- 参照実装（UrawaCup/new）は95%完成
- フロントエンド13画面すべて実装済み
- final_day.pyはcoreロジックと完全に一致

**弱み:**
- レポート出力、認証、テスト、本番対応が不足
- セキュリティ関連の設定が開発環境向け
- coreのPDF生成クラスがimpl-repoに未移植
- テストフィクスチャの不備で8件のテストが失敗

**緊急対応項目:**
- [x] ISSUE-016: デフォルトシークレットキーの修正（解決済み）
- [x] ISSUE-009: 結果承認フローの実装（解決済み）
- [ ] ISSUE-029: coreのDailyReportGenerator移植
- [ ] ISSUE-030: coreのFinalResultPDFGenerator移植
- [ ] ISSUE-031: テストフィクスチャ修正

**本番デプロイ前チェックリスト:**
- [ ] テストカバレッジ80%以上達成
- [ ] セキュリティ監査実施（ISSUE-017対応必須）
- [ ] パフォーマンステスト実施（50同時接続）
- [ ] エラーハンドリング完全化（ISSUE-026対応）
- [ ] ロギング・モニタリング整備（ISSUE-014, 024対応）
- [ ] バックアップ・復旧手順の確立
- [ ] coreロジックとの完全統合（ISSUE-029〜032対応）
